<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ETAPA 2a — Preparação do Painel CAGED + ILO Exposure Index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/clipboard/clipboard.min.js"></script>
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/popper.min.js"></script>
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/anchor.min.js"></script>
<link href="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="etapa_2a_preparacao_dados_did_caged_ilo_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#contextualização" id="toc-contextualização" class="nav-link active" data-scroll-target="#contextualização"><span class="header-section-number">0.1</span> Contextualização</a></li>
  <li><a href="#objetivo" id="toc-objetivo" class="nav-link" data-scroll-target="#objetivo"><span class="header-section-number">0.2</span> Objetivo</a></li>
  <li><a href="#ficha-técnica-dos-dados" id="toc-ficha-técnica-dos-dados" class="nav-link" data-scroll-target="#ficha-técnica-dos-dados"><span class="header-section-number">0.3</span> Ficha Técnica dos Dados</a></li>
  <li><a href="#referências-principais" id="toc-referências-principais" class="nav-link" data-scroll-target="#referências-principais"><span class="header-section-number">0.4</span> Referências principais</a></li>
  <li><a href="#configuração-do-ambiente" id="toc-configuração-do-ambiente" class="nav-link" data-scroll-target="#configuração-do-ambiente"><span class="header-section-number">0.5</span> 1. Configuração do ambiente</a></li>
  <li><a href="#índice-ipca-deflator-para-salário-real" id="toc-índice-ipca-deflator-para-salário-real" class="nav-link" data-scroll-target="#índice-ipca-deflator-para-salário-real"><span class="header-section-number">0.6</span> 2. Índice IPCA (deflator para salário real)</a></li>
  <li><a href="#a.-download-dos-microdados-caged" id="toc-a.-download-dos-microdados-caged" class="nav-link" data-scroll-target="#a.-download-dos-microdados-caged"><span class="header-section-number">0.7</span> 2a. Download dos microdados CAGED</a></li>
  <li><a href="#b.-verificar-dados-caged-checkpoint" id="toc-b.-verificar-dados-caged-checkpoint" class="nav-link" data-scroll-target="#b.-verificar-dados-caged-checkpoint"><span class="header-section-number">0.8</span> 2b. Verificar dados CAGED (CHECKPOINT)</a></li>
  <li><a href="#a.-agregação-microdados-painel-mensal-por-ocupação" id="toc-a.-agregação-microdados-painel-mensal-por-ocupação" class="nav-link" data-scroll-target="#a.-agregação-microdados-painel-mensal-por-ocupação"><span class="header-section-number">0.9</span> 3a. Agregação: Microdados → Painel Mensal por Ocupação</a></li>
  <li><a href="#b.-verificar-painel-agregado-checkpoint" id="toc-b.-verificar-painel-agregado-checkpoint" class="nav-link" data-scroll-target="#b.-verificar-painel-agregado-checkpoint"><span class="header-section-number">0.10</span> 3b. Verificar painel agregado (CHECKPOINT)</a></li>
  <li><a href="#a.-crosswalk-cbo-2002-isco-08" id="toc-a.-crosswalk-cbo-2002-isco-08" class="nav-link" data-scroll-target="#a.-crosswalk-cbo-2002-isco-08"><span class="header-section-number">0.11</span> 4a. Crosswalk CBO 2002 → ISCO-08</a></li>
  <li><a href="#b.-verificar-crosswalk-checkpoint" id="toc-b.-verificar-crosswalk-checkpoint" class="nav-link" data-scroll-target="#b.-verificar-crosswalk-checkpoint"><span class="header-section-number">0.12</span> 4b. Verificar crosswalk (CHECKPOINT)</a></li>
  <li><a href="#a.-definição-de-tratamento" id="toc-a.-definição-de-tratamento" class="nav-link" data-scroll-target="#a.-definição-de-tratamento"><span class="header-section-number">0.13</span> 5a. Definição de tratamento</a></li>
  <li><a href="#b.-verificar-tratamento-checkpoint" id="toc-b.-verificar-tratamento-checkpoint" class="nav-link" data-scroll-target="#b.-verificar-tratamento-checkpoint"><span class="header-section-number">0.14</span> 5b. Verificar tratamento (CHECKPOINT)</a></li>
  <li><a href="#a.-enriquecimento-do-painel-variáveis-adicionais" id="toc-a.-enriquecimento-do-painel-variáveis-adicionais" class="nav-link" data-scroll-target="#a.-enriquecimento-do-painel-variáveis-adicionais"><span class="header-section-number">0.15</span> 6a. Enriquecimento do painel (variáveis adicionais)</a></li>
  <li><a href="#anexo-1-integração-anthropic-automation-vs-augmentation" id="toc-anexo-1-integração-anthropic-automation-vs-augmentation" class="nav-link" data-scroll-target="#anexo-1-integração-anthropic-automation-vs-augmentation"><span class="header-section-number">0.16</span> Anexo 1: Integração Anthropic (Automation vs Augmentation)</a></li>
  <li><a href="#salvar-dataset-analítico-final" id="toc-salvar-dataset-analítico-final" class="nav-link" data-scroll-target="#salvar-dataset-analítico-final"><span class="header-section-number">0.17</span> 7. Salvar dataset analítico final</a></li>
  <li><a href="#limitações-desta-etapa" id="toc-limitações-desta-etapa" class="nav-link" data-scroll-target="#limitações-desta-etapa"><span class="header-section-number">0.18</span> Limitações desta etapa</a></li>
  <li><a href="#checklist-de-entregáveis" id="toc-checklist-de-entregáveis" class="nav-link" data-scroll-target="#checklist-de-entregáveis"><span class="header-section-number">0.19</span> Checklist de entregáveis</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="etapa_2a_preparacao_dados_did_caged_ilo.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ETAPA 2a — Preparação do Painel CAGED + ILO Exposure Index</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Dissertação:</strong> Inteligência Artificial Generativa e o Mercado de Trabalho Brasileiro: Uma Análise de Exposição Ocupacional e seus Efeitos Distributivos.</p>
<p><strong>Aluno:</strong> Manoel Brasil Orlandi</p>
<hr>
<section id="contextualização" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="contextualização"><span class="header-section-number">0.1</span> Contextualização</h3>
<p>A rápida difusão de modelos de IA generativa (LLMs, geradores de imagem/código) levanta questões centrais sobre seus impactos no mercado de trabalho. Para mensurar esse potencial de impacto, a Organização Internacional do Trabalho (OIT) criou um índice de exposição ocupacional à IA generativa, publicado como <em>Working Paper</em> 140 (WP140). O índice atribui scores de exposição a cada ocupação da classificação ISCO-08, com base na avaliação de suas tarefas constituintes por modelos de linguagem e validação humana.</p>
<p>Este notebook prepara uma base de dados que junta os dados do <strong>Novo CAGED</strong> (Cadastro Geral de Empregados e Desempregados) ao <strong>índice de exposição à IA generativa da OIT</strong>, para ser usado em um modelo de Diferenças-em-Diferenças (DiD) no Notebook 2b.</p>
</section>
<section id="objetivo" class="level3" data-number="0.2">
<h3 data-number="0.2" class="anchored" data-anchor-id="objetivo"><span class="header-section-number">0.2</span> Objetivo</h3>
<p>Construir o <strong>painel mensal de ocupações formais brasileiras (2021–2025)</strong> a partir do Novo CAGED, realizar o <strong>crosswalk CBO 2002 → ISCO-08</strong> (especificação dual: 2 dígitos como principal, 4 dígitos para robustez), e fazer o merge com o índice de exposição à IA generativa da OIT (Gmyrek, Berg &amp; Cappelli, 2025). O output final é um dataset analítico pronto para a estimação DiD.</p>
<p><strong>Estratégia de crosswalk:</strong> Análise principal a <strong>2 dígitos</strong> ISCO-08 (match por Sub-major Group com fallback hierárquico a Major Group), com robustez a <strong>4 dígitos</strong> via correspondência ISCO-88 ↔︎ ISCO-08 + fallback hierárquico em 6 níveis.</p>
<p><strong>Inspiração metodológica:</strong> Hui, Reshef &amp; Zhou (2024), “The Short-Term Effects of Generative Artificial Intelligence on Employment: Evidence from an Online Labor Market” — adaptado para dados administrativos brasileiros (CAGED) com o índice ILO de exposição ocupacional.</p>
</section>
<section id="ficha-técnica-dos-dados" class="level3" data-number="0.3">
<h3 data-number="0.3" class="anchored" data-anchor-id="ficha-técnica-dos-dados"><span class="header-section-number">0.3</span> Ficha Técnica dos Dados</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 64%">
</colgroup>
<thead>
<tr class="header">
<th>Item</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Fonte CAGED</strong></td>
<td>Ministério do Trabalho e Emprego (MTE), via Base dos Dados (BigQuery)</td>
</tr>
<tr class="even">
<td><strong>Dataset BigQuery</strong></td>
<td><code>basedosdados.br_me_caged.microdados_movimentacao</code></td>
</tr>
<tr class="odd">
<td><strong>Período</strong></td>
<td>Janeiro/2021 — Dezembro/2025 (60 meses)</td>
</tr>
<tr class="even">
<td><strong>Unidade</strong></td>
<td>Movimentação individual (admissão ou desligamento)</td>
</tr>
<tr class="odd">
<td><strong>Cobertura</strong></td>
<td>Emprego formal (CLT) em todo o Brasil</td>
</tr>
<tr class="even">
<td><strong>Índice ILO</strong></td>
<td><code>ilo_exposure_clean.csv</code> — 427 ocupações ISCO-08 com exposure scores</td>
</tr>
<tr class="odd">
<td><strong>Classificação</strong></td>
<td>CBO 2002 (CAGED) → ISCO-08 (ILO) via crosswalk hierárquico</td>
</tr>
</tbody>
</table>
</section>
<section id="referências-principais" class="level3" data-number="0.4">
<h3 data-number="0.4" class="anchored" data-anchor-id="referências-principais"><span class="header-section-number">0.4</span> Referências principais</h3>
<ul>
<li>Gmyrek, P., Berg, J. &amp; Cappelli, D. (2025). <em>Generative AI and Jobs: An updated global assessment</em>. ILO Working Paper 140.</li>
<li>Hui, X., Reshef, O. &amp; Zhou, L. (2024). <em>The Short-Term Effects of Generative AI on Employment</em>. Organization Science, 35(6).</li>
<li>Brynjolfsson, E., Chandar, P. &amp; Chen, J. (2025). <em>Canaries in the Coal Mine? Six Facts about the Recent Employment Effects of AI</em>.</li>
<li>Callaway, B. &amp; Sant’Anna, P. (2021). <em>Difference-in-differences with multiple time periods</em>. Journal of Econometrics, 225(2).</li>
<li>Muendler, M.-A. &amp; Poole, J.P. (2004). <em>Job Concordances for Brazil: Mapping CBO to ISCO-88</em>. UC San Diego.</li>
</ul>
</section>
<section id="configuração-do-ambiente" class="level3" data-number="0.5">
<h3 data-number="0.5" class="anchored" data-anchor-id="configuração-do-ambiente"><span class="header-section-number">0.5</span> 1. Configuração do ambiente</h3>
<p>Definir caminhos, importar bibliotecas e configurar parâmetros do painel. Todos os caminhos são relativos ao diretório <code>notebook/</code>.</p>
<blockquote class="blockquote">
<p><strong>Nota sobre a janela temporal:</strong> Excluímos 2020 para evitar os efeitos distorcivos da pandemia de COVID-19 sobre o mercado de trabalho formal. O ano de 2020 apresentou quedas e recuperações atípicas que contaminariam o período pré-tratamento do DiD. A janela Jan/2021–Dez/2025 oferece 23 meses pré-ChatGPT e 31 meses pós.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Nota sobre o Novo CAGED:</strong> A partir de janeiro/2020, o CAGED foi substituído pelo sistema eSocial (Portaria SEPRT 1.127/2019). Usamos dados de 2021+ para consistência metodológica (eSocial já estabilizado).</p>
</blockquote>
<div id="f87dfc8f" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar dependências e instalar apenas o que faltar (rode esta célula primeiro)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib.util</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># (nome para import, nome para pip install)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>PACOTES <span class="op">=</span> [</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"pandas"</span>, <span class="st">"pandas"</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"numpy"</span>, <span class="st">"numpy"</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"pyarrow"</span>, <span class="st">"pyarrow"</span>),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"matplotlib"</span>, <span class="st">"matplotlib"</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"seaborn"</span>, <span class="st">"seaborn"</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"scipy"</span>, <span class="st">"scipy"</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"pyfixest"</span>, <span class="st">"pyfixest"</span>),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"bcb"</span>, <span class="st">"python-bcb"</span>),  <span class="co"># IPCA Banco Central; import: from bcb import sgs</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"xlrd"</span>, <span class="st">"xlrd"</span>),  <span class="co"># Leitura de .xls (Crosswalk SOC/ISCO, Estrutura COD) — Anexo 1</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"openpyxl"</span>, <span class="st">"openpyxl"</span>),  <span class="co"># Leitura de .xlsx (Crosswalk SOC 2010 a 2018) — Anexo 1</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"google.cloud.bigquery"</span>, <span class="st">"google-cloud-bigquery"</span>),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ja_instalado(nome_import):</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> importlib.util.find_spec(nome_import) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>faltando <span class="op">=</span> [pip <span class="cf">for</span> imp, pip <span class="kw">in</span> PACOTES <span class="cf">if</span> <span class="kw">not</span> ja_instalado(imp)]</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> faltando:</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    subprocess.check_call([sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, <span class="st">"-q"</span>] <span class="op">+</span> faltando)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Instalado:"</span>, <span class="st">", "</span>.join(faltando))</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Todas as dependências já estão instaladas."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Instalado: xlrd</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">[</span><span class="ansi-blue-fg">notice</span><span class="ansi-bold">]</span> A new release of pip is available: <span class="ansi-red-fg">24.2</span> -&gt; <span class="ansi-green-fg">26.0.1</span>

<span class="ansi-bold">[</span><span class="ansi-blue-fg">notice</span><span class="ansi-bold">]</span> To update, run: <span class="ansi-green-fg">python3.10 -m pip install --upgrade pip</span>
</pre>
</div>
</div>
</div>
<div id="02d36db5" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.1 — Configuração do ambiente</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Caminhos (relativos ao diretório do notebook)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>DATA_INPUT     <span class="op">=</span> Path(<span class="st">"data/input"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>DATA_RAW       <span class="op">=</span> Path(<span class="st">"data/raw"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>DATA_PROCESSED <span class="op">=</span> Path(<span class="st">"data/processed"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>DATA_OUTPUT    <span class="op">=</span> Path(<span class="st">"data/output"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> [DATA_INPUT, DATA_RAW, DATA_PROCESSED, DATA_OUTPUT]:</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    d.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Parâmetros do Painel CAGED</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>GCP_PROJECT_ID <span class="op">=</span> <span class="st">"mestrado-pnad-2026"</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>ANO_INICIO     <span class="op">=</span> <span class="dv">2021</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>ANO_FIM        <span class="op">=</span> <span class="dv">2025</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>ANO_TRATAMENTO <span class="op">=</span> <span class="dv">2022</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>MES_TRATAMENTO <span class="op">=</span> <span class="dv">12</span>   <span class="co"># Dezembro/2022 como primeiro mês "pós"</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>SALARIO_MINIMO <span class="op">=</span> {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2021</span>: <span class="dv">1100</span>, <span class="dv">2022</span>: <span class="dv">1212</span>, <span class="dv">2023</span>: <span class="dv">1320</span>, <span class="dv">2024</span>: <span class="dv">1412</span>, <span class="dv">2025</span>: <span class="dv">1518</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Colunas a selecionar do CAGED (BigQuery)</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>COLUNAS_CAGED <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="st">    ano, mes, sigla_uf, id_municipio, cbo_2002,</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="st">    categoria, tipo_movimentacao, saldo_movimentacao,</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="st">    salario_mensal, grau_instrucao, idade, sexo, raca_cor,</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="st">    cnae_2_secao, cnae_2_subclasse, tamanho_estabelecimento_janeiro</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Arquivos de referência</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>ILO_FILE               <span class="op">=</span> DATA_PROCESSED <span class="op">/</span> <span class="st">"ilo_exposure_clean.csv"</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>ISCO_08_88_FILE        <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"Correspondência ISCO 08 a 88.xlsx"</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>ISCO_08_ESTRUTURA_FILE <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"ISCO 08 Estruturas e Definições.xlsx"</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>MUENDLER_FILE          <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"cbo-isco-conc.csv"</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Checkpoints intermediários</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>PAINEL_MENSAL_FILE     <span class="op">=</span> DATA_PROCESSED <span class="op">/</span> <span class="st">"painel_caged_mensal.parquet"</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>PAINEL_CROSSWALK_FILE  <span class="op">=</span> DATA_PROCESSED <span class="op">/</span> <span class="st">"painel_caged_crosswalk.parquet"</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>PAINEL_TRATAMENTO_FILE <span class="op">=</span> DATA_PROCESSED <span class="op">/</span> <span class="st">"painel_caged_tratamento.parquet"</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>PAINEL_FINAL_PARQUET   <span class="op">=</span> DATA_OUTPUT <span class="op">/</span> <span class="st">"painel_caged_did_ready.parquet"</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>PAINEL_FINAL_CSV       <span class="op">=</span> DATA_OUTPUT <span class="op">/</span> <span class="st">"painel_caged_did_ready.csv"</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Cache: quando False, arquivos são deletados antes de (re)gerar (força reprocessamento)</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>KEEP_CAGED_RAW         <span class="op">=</span> <span class="va">True</span>   <span class="co"># data/raw/caged_*.parquet</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>KEEP_PANEL_MENSAL      <span class="op">=</span> <span class="va">True</span>   <span class="co"># painel_caged_mensal.parquet</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>KEEP_PANEL_CROSSWALK   <span class="op">=</span> <span class="va">True</span>   <span class="co"># painel_caged_crosswalk.parquet</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>KEEP_PANEL_TRATAMENTO  <span class="op">=</span> <span class="va">False</span>   <span class="co"># painel_caged_tratamento.parquet</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>KEEP_PANEL_FINAL       <span class="op">=</span> <span class="va">False</span>   <span class="co"># painel_caged_did_ready.parquet/csv</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>KEEP_ANTHROPIC_INDEX   <span class="op">=</span> <span class="va">True</span>    <span class="co"># anthropic_automation_augmentation_cbo.parquet (Anexo 1)</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Cache do índice Anthropic (Automation vs Augmentation) — Anexo 1</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>ANTHROPIC_INDEX_CACHE  <span class="op">=</span> DATA_PROCESSED <span class="op">/</span> <span class="st">"anthropic_automation_augmentation_cbo.parquet"</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Deflator (salário real): índice base para IPCA</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>INDICE_BASE_ANO <span class="op">=</span> <span class="dv">2024</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>INDICE_BASE_MES <span class="op">=</span> <span class="dv">12</span>   <span class="co"># Dez/2024 = 100</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>INDICE_BASE     <span class="op">=</span> <span class="fl">100.0</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>IPCA_MENSAL_FILE <span class="op">=</span> DATA_PROCESSED <span class="op">/</span> <span class="st">"ipca_mensal.parquet"</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Setor tecnológico (CNAE 2.0 seção): J = Informação e comunicação; M = Atividades profissionais/científicas</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>CNAE_SECOES_TECNOLOGICO <span class="op">=</span> [<span class="st">'J'</span>]   <span class="co"># ou ['J', 'M'] para incluir atividades profissionais/científicas</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>SETOR_TECNOLOGICO_LIMIAR <span class="op">=</span> <span class="fl">0.5</span>    <span class="co"># setor_tecnologico=1 quando pct_tecnologico_adm &gt;= este limiar</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Grandes grupos CBO (para sanity checks)</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>GRANDES_GRUPOS_CBO <span class="op">=</span> {</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'0'</span>: <span class="st">'Forças Armadas'</span>,</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">'1'</span>: <span class="st">'Dirigentes'</span>,</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2'</span>: <span class="st">'Profissionais das ciências'</span>,</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="st">'3'</span>: <span class="st">'Técnicos nível médio'</span>,</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">'4'</span>: <span class="st">'Trabalhadores de serv. admin.'</span>,</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">'5'</span>: <span class="st">'Trabalhadores de serviços/comércio'</span>,</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">'6'</span>: <span class="st">'Agropecuária'</span>,</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">'7'</span>: <span class="st">'Produção industrial'</span>,</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">'8'</span>: <span class="st">'Operadores de máquinas'</span>,</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">'9'</span>: <span class="st">'Manutenção e reparação'</span>,</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Configuração carregada."</span>)</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Período: </span><span class="sc">{</span>ANO_INICIO<span class="sc">}</span><span class="ss">–</span><span class="sc">{</span>ANO_FIM<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(ANO_FIM <span class="op">-</span> ANO_INICIO <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">12</span><span class="sc">}</span><span class="ss"> meses)"</span>)</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Evento: ChatGPT — Nov/2022 (pós a partir de </span><span class="sc">{</span>MES_TRATAMENTO<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>ANO_TRATAMENTO<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Projeto GCP: </span><span class="sc">{</span>GCP_PROJECT_ID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  ILO file: </span><span class="sc">{</span>ILO_FILE<span class="sc">}</span><span class="ss"> (existe: </span><span class="sc">{</span>ILO_FILE<span class="sc">.</span>exists()<span class="sc">}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Configuração carregada.
  Período: 2021–2025 (60 meses)
  Evento: ChatGPT — Nov/2022 (pós a partir de 12/2022)
  Projeto GCP: mestrado-pnad-2026
  ILO file: data/processed/ilo_exposure_clean.csv (existe: True)</code></pre>
</div>
</div>
</section>
<section id="índice-ipca-deflator-para-salário-real" class="level3" data-number="0.6">
<h3 data-number="0.6" class="anchored" data-anchor-id="índice-ipca-deflator-para-salário-real"><span class="header-section-number">0.6</span> 2. Índice IPCA (deflator para salário real)</h3>
<p>Carregar série mensal do IPCA (Banco Central SGS) e construir índice com base Dez/2024 = 100, para deflacionar salários nominais no enriquecimento do painel.</p>
<div id="eeaba3d2" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.2 — Índice IPCA mensal (base Dez/2024 = 100)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fonte: Banco Central SGS (série 433 = variação mensal IPCA). Índice construído por acumulação.</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> IPCA_MENSAL_FILE.exists():</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    df_ipca <span class="op">=</span> pd.read_parquet(IPCA_MENSAL_FILE)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Índice IPCA carregado do cache: </span><span class="sc">{</span>IPCA_MENSAL_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Período: </span><span class="sc">{</span>df_ipca[<span class="st">'ano'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df_ipca[<span class="st">'mes'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> a </span><span class="sc">{</span>df_ipca[<span class="st">'ano'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df_ipca[<span class="st">'mes'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">, base </span><span class="sc">{</span>INDICE_BASE_ANO<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>INDICE_BASE_MES<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>INDICE_BASE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> bcb <span class="im">import</span> sgs</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Série 433 = IPCA - Variação mensal (%)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ANO_INICIO<span class="sc">}</span><span class="ss">-01-01"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ANO_FIM<span class="sc">}</span><span class="ss">-12-31"</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> sgs.get({<span class="st">"IPCA_var"</span>: <span class="dv">433</span>}, start<span class="op">=</span>start, end<span class="op">=</span>end)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> raw.reset_index()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    raw.columns <span class="op">=</span> [<span class="st">"data"</span>, <span class="st">"variacao"</span>]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    raw[<span class="st">"ano"</span>] <span class="op">=</span> raw[<span class="st">"data"</span>].dt.year</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    raw[<span class="st">"mes"</span>] <span class="op">=</span> raw[<span class="st">"data"</span>].dt.month</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ordenar por tempo e construir índice: base = 100 no mês INDICE_BASE_ANO/INDICE_BASE_MES</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> raw.sort_values([<span class="st">"ano"</span>, <span class="st">"mes"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    raw[<span class="st">"fator"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> raw[<span class="st">"variacao"</span>] <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Índice em cadeia: 100 no mês base; para trás divide pelo fator do mês seguinte; para frente multiplica</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    base_idx <span class="op">=</span> raw[(raw[<span class="st">"ano"</span>] <span class="op">==</span> INDICE_BASE_ANO) <span class="op">&amp;</span> (raw[<span class="st">"mes"</span>] <span class="op">==</span> INDICE_BASE_MES)].index</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(base_idx) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Mês base </span><span class="sc">{</span>INDICE_BASE_ANO<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>INDICE_BASE_MES<span class="sc">}</span><span class="ss"> não encontrado na série IPCA."</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    base_idx <span class="op">=</span> base_idx[<span class="dv">0</span>]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    indice <span class="op">=</span> np.ones(<span class="bu">len</span>(raw)) <span class="op">*</span> np.nan</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    indice[base_idx] <span class="op">=</span> INDICE_BASE</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(base_idx <span class="op">-</span> <span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        indice[i] <span class="op">=</span> indice[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">/</span> raw.loc[i <span class="op">+</span> <span class="dv">1</span>, <span class="st">"fator"</span>]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(base_idx <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(raw)):</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        indice[i] <span class="op">=</span> indice[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">*</span> raw.loc[i, <span class="st">"fator"</span>]</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    raw[<span class="st">"indice"</span>] <span class="op">=</span> indice</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    df_ipca <span class="op">=</span> raw[[<span class="st">"ano"</span>, <span class="st">"mes"</span>, <span class="st">"indice"</span>]].copy()</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    df_ipca.to_parquet(IPCA_MENSAL_FILE, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Índice IPCA construído e salvo: </span><span class="sc">{</span>IPCA_MENSAL_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Período: </span><span class="sc">{</span>df_ipca[<span class="st">'ano'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df_ipca[<span class="st">'mes'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> a </span><span class="sc">{</span>df_ipca[<span class="st">'ano'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df_ipca[<span class="st">'mes'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">, base </span><span class="sc">{</span>INDICE_BASE_ANO<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>INDICE_BASE_MES<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>INDICE_BASE<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Índice IPCA carregado do cache: ipca_mensal.parquet
  Período: 2021-1 a 2025-12, base 2024/12 = 100.0</code></pre>
</div>
</div>
</section>
<section id="a.-download-dos-microdados-caged" class="level3" data-number="0.7">
<h3 data-number="0.7" class="anchored" data-anchor-id="a.-download-dos-microdados-caged"><span class="header-section-number">0.7</span> 2a. Download dos microdados CAGED</h3>
<p>Extrair do Novo CAGED (BigQuery/Base dos Dados) todas as movimentações de emprego formal no período 2021–2025.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 64%">
</colgroup>
<thead>
<tr class="header">
<th>Item</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Tabela BigQuery</strong></td>
<td><code>basedosdados.br_me_caged.microdados_movimentacao</code></td>
</tr>
<tr class="even">
<td><strong>Período</strong></td>
<td>2021-01 a 2025-12</td>
</tr>
<tr class="odd">
<td><strong>Filtros</strong></td>
<td><code>ano BETWEEN 2021 AND 2025</code></td>
</tr>
<tr class="even">
<td><strong>Volume estimado</strong></td>
<td>~20-30M de registros por ano, ~100-150M total</td>
</tr>
<tr class="odd">
<td><strong>Estratégia</strong></td>
<td>Download ano a ano via <code>google-cloud-bigquery</code> (Storage API) com fallback para <code>basedosdados</code></td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><strong>Nota metodológica — Volume de dados:</strong> O CAGED registra ~20-25 milhões de movimentações/ano. Para 5 anos, esperamos ~100-125M de registros. O download é feito ano a ano para evitar OOM e timeout, com salvamento em parquets individuais (<code>caged_{ano}.parquet</code>).</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Nota sobre otimização:</strong> Usamos a BigQuery Storage API (<code>create_bqstorage_client=True</code>) que transfere dados via gRPC/Arrow, sendo 2-5x mais rápida que o método padrão REST. Se o arquivo parquet já existir, o download é pulado automaticamente.</p>
</blockquote>
<div id="451ca3b3" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.2a — Download dos microdados CAGED</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Estratégia: download ano a ano via BigQuery Storage API, com cache local em parquet.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> KEEP_CAGED_RAW:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> DATA_RAW.glob(<span class="st">"caged_*.parquet"</span>):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        f.unlink()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Cache CAGED removido: </span><span class="sc">{</span>f<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.cloud <span class="im">import</span> bigquery</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_caged_ano(ano):</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Baixar microdados CAGED de um ano via BigQuery Storage API."""</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    parquet_path <span class="op">=</span> DATA_RAW <span class="op">/</span> <span class="ss">f"caged_</span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">.parquet"</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parquet_path.exists():</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        size_mb <span class="op">=</span> parquet_path.stat().st_size <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_parquet(parquet_path)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">: Carregado do cache — </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> registros (</span><span class="sc">{</span>size_mb<span class="sc">:.0f}</span><span class="ss"> MB)"</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">: Baixando do BigQuery..."</span>, end<span class="op">=</span><span class="st">""</span>, flush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="ss">    SELECT </span><span class="sc">{</span>COLUNAS_CAGED<span class="sc">}</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="ss">    FROM `basedosdados.br_me_caged.microdados_movimentacao`</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="ss">    WHERE ano = </span><span class="sc">{</span>ano<span class="sc">}</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> bigquery.Client(project<span class="op">=</span>GCP_PROJECT_ID)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> client.query(query).to_dataframe(create_bqstorage_client<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    df.to_parquet(parquet_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    size_mb <span class="op">=</span> parquet_path.stat().st_size <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> registros (</span><span class="sc">{</span>size_mb<span class="sc">:.0f}</span><span class="ss"> MB)"</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Download ano a ano</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Download dos microdados CAGED:"</span>)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>dfs_anuais <span class="op">=</span> []</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ano <span class="kw">in</span> <span class="bu">range</span>(ANO_INICIO, ANO_FIM <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    df_ano <span class="op">=</span> download_caged_ano(ano)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    dfs_anuais.append(df_ano)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumo (sem concatenar em memória para evitar OOM)</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(df) <span class="cf">for</span> df <span class="kw">in</span> dfs_anuais)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total: </span><span class="sc">{</span>total<span class="sc">:,}</span><span class="ss"> movimentações (</span><span class="sc">{</span>ANO_INICIO<span class="sc">}</span><span class="ss">–</span><span class="sc">{</span>ANO_FIM<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Colunas: </span><span class="sc">{</span><span class="bu">list</span>(dfs_anuais[<span class="dv">0</span>].columns)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Download dos microdados CAGED:
  2021: Carregado do cache — 36,554,795 registros (380 MB)
  2022: Carregado do cache — 42,475,516 registros (441 MB)
  2023: Carregado do cache — 44,485,982 registros (469 MB)
  2024: Carregado do cache — 48,996,040 registros (510 MB)
  2025: Carregado do cache — 26,312,103 registros (269 MB)

Total: 198,824,436 movimentações (2021–2025)
Colunas: ['ano', 'mes', 'sigla_uf', 'id_municipio', 'cbo_2002', 'categoria', 'tipo_movimentacao', 'saldo_movimentacao', 'salario_mensal', 'grau_instrucao', 'idade', 'sexo', 'raca_cor', 'cnae_2_secao', 'cnae_2_subclasse', 'tamanho_estabelecimento_janeiro']</code></pre>
</div>
</div>
</section>
<section id="b.-verificar-dados-caged-checkpoint" class="level3" data-number="0.8">
<h3 data-number="0.8" class="anchored" data-anchor-id="b.-verificar-dados-caged-checkpoint"><span class="header-section-number">0.8</span> 2b. Verificar dados CAGED (CHECKPOINT)</h3>
<p>Verificar integridade dos dados baixados: cobertura temporal (12 meses/ano), volume por ano, preenchimento de variáveis-chave, e formato dos códigos CBO.</p>
<p><strong>Critérios de aceite:</strong> - Todos os meses cobertos (Jan–Dez) para cada ano - CBO com &gt;95% de preenchimento - ~20-30M registros por ano</p>
<div id="63efdd50" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.2b — CHECKPOINT: Verificar dados CAGED</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Carrega cada parquet individualmente (para evitar OOM)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CHECKPOINT — Microdados CAGED"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>total_registros <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ano <span class="kw">in</span> <span class="bu">range</span>(ANO_INICIO, ANO_FIM <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    parquet_path <span class="op">=</span> DATA_RAW <span class="op">/</span> <span class="ss">f"caged_</span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">.parquet"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_parquet(parquet_path)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volume</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- </span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> movimentações ---"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    total_registros <span class="op">+=</span> <span class="bu">len</span>(df)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cobertura mensal</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    meses <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">'mes'</span>].dropna().unique())</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"OK"</span> <span class="cf">if</span> <span class="bu">len</span>(meses) <span class="op">==</span> <span class="dv">12</span> <span class="cf">else</span> <span class="ss">f"ALERTA: </span><span class="sc">{</span><span class="bu">len</span>(meses)<span class="sc">}</span><span class="ss"> meses"</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Meses: </span><span class="sc">{</span><span class="bu">len</span>(meses)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preenchimento CBO</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    cbo_pct <span class="op">=</span> df[<span class="st">'cbo_2002'</span>].notna().mean()</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CBO preenchido: </span><span class="sc">{</span>cbo_pct<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CBOs únicos</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    cbos <span class="op">=</span> df[<span class="st">'cbo_2002'</span>].dropna().astype(<span class="bu">str</span>).<span class="bu">str</span>[:<span class="dv">4</span>].nunique()</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Famílias CBO 4d únicas: </span><span class="sc">{</span>cbos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Admissões vs desligamentos</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'saldo_movimentacao'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        adm <span class="op">=</span> (df[<span class="st">'saldo_movimentacao'</span>] <span class="op">==</span> <span class="dv">1</span>).<span class="bu">sum</span>()</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        desl <span class="op">=</span> (df[<span class="st">'saldo_movimentacao'</span>] <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>).<span class="bu">sum</span>()</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Admissões: </span><span class="sc">{</span>adm<span class="sc">:,}</span><span class="ss"> | Desligamentos: </span><span class="sc">{</span>desl<span class="sc">:,}</span><span class="ss"> | Saldo: </span><span class="sc">{</span>adm<span class="op">-</span>desl<span class="sc">:+,}</span><span class="ss">"</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"TOTAL: </span><span class="sc">{</span>total_registros<span class="sc">:,}</span><span class="ss"> movimentações (</span><span class="sc">{</span>ANO_INICIO<span class="sc">}</span><span class="ss">–</span><span class="sc">{</span>ANO_FIM<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
CHECKPOINT — Microdados CAGED
============================================================

--- 2021: 36,554,795 movimentações ---
  Meses: 12 (OK)
  CBO preenchido: 100.0%
  Famílias CBO 4d únicas: 626
  Admissões: 19,703,604 | Desligamentos: 16,851,191 | Saldo: +2,852,413

--- 2022: 42,475,516 movimentações ---
  Meses: 12 (OK)
  CBO preenchido: 100.0%
  Famílias CBO 4d únicas: 624
  Admissões: 22,243,441 | Desligamentos: 20,232,075 | Saldo: +2,011,366

--- 2023: 44,485,982 movimentações ---
  Meses: 12 (OK)
  CBO preenchido: 100.0%
  Famílias CBO 4d únicas: 626
  Admissões: 22,982,161 | Desligamentos: 21,503,821 | Saldo: +1,478,340

--- 2024: 48,996,040 movimentações ---
  Meses: 12 (OK)
  CBO preenchido: 100.0%
  Famílias CBO 4d únicas: 625
  Admissões: 25,336,277 | Desligamentos: 23,659,763 | Saldo: +1,676,514

--- 2025: 26,312,103 movimentações ---
  Meses: 6 (ALERTA: 6 meses)
  CBO preenchido: 100.0%
  Famílias CBO 4d únicas: 622
  Admissões: 13,763,059 | Desligamentos: 12,549,044 | Saldo: +1,214,015

============================================================
TOTAL: 198,824,436 movimentações (2021–2025)
============================================================</code></pre>
</div>
</div>
</section>
<section id="a.-agregação-microdados-painel-mensal-por-ocupação" class="level3" data-number="0.9">
<h3 data-number="0.9" class="anchored" data-anchor-id="a.-agregação-microdados-painel-mensal-por-ocupação"><span class="header-section-number">0.9</span> 3a. Agregação: Microdados → Painel Mensal por Ocupação</h3>
<p>Agregar os microdados de movimentação (nível individual) em um painel mensal por ocupação CBO (4 dígitos). Cada linha do painel representará uma ocupação-mês com métricas agregadas.</p>
<section id="estratégia-de-agregação" class="level4" data-number="0.9.1">
<h4 data-number="0.9.1" class="anchored" data-anchor-id="estratégia-de-agregação"><span class="header-section-number">0.9.1</span> Estratégia de agregação</h4>
<p>Seguindo a abordagem de Hui, Reshef &amp; Zhou (2024), construímos um painel ao nível de <strong>ocupação × mês</strong> com as seguintes métricas:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 31%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th>Métrica</th>
<th>Cálculo</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>admissoes</code></td>
<td>Contagem de <code>saldo_movimentacao == 1</code></td>
<td>Fluxo de contratação</td>
</tr>
<tr class="even">
<td><code>desligamentos</code></td>
<td>Contagem de <code>saldo_movimentacao == -1</code></td>
<td>Fluxo de demissão</td>
</tr>
<tr class="odd">
<td><code>saldo</code></td>
<td><code>admissoes - desligamentos</code></td>
<td>Criação líquida de empregos</td>
</tr>
<tr class="even">
<td><code>salario_medio_adm</code></td>
<td>Média do <code>salario_mensal</code> (admissões)</td>
<td>Nível salarial</td>
</tr>
<tr class="odd">
<td><code>salario_mediano_adm</code></td>
<td>Mediana do <code>salario_mensal</code> (admissões)</td>
<td>Robustez a outliers</td>
</tr>
<tr class="even">
<td><code>pct_mulher_adm</code></td>
<td>% de <code>sexo == 3</code> nas admissões</td>
<td>Composição de gênero</td>
</tr>
<tr class="odd">
<td><code>pct_superior_adm</code></td>
<td>% com <code>grau_instrucao &gt;= 9</code></td>
<td>Composição educacional</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><strong>Nota — CBO 4 dígitos:</strong> A CBO tem 6 dígitos (XXXX-XX), onde os 4 primeiros definem a “família” ocupacional. Para o crosswalk com ISCO-08, usamos os 4 primeiros dígitos (família CBO ≈ unit group ISCO-08).</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Nota — Otimização de memória:</strong> O processamento é feito ano a ano para evitar OOM (Out-of-Memory) com ~100M+ registros. Flags booleanos são pré-computados como float para permitir agregação vetorizada (evitando lambdas lentas). A mediana é calculada separadamente por ser computacionalmente cara.</p>
</blockquote>
<p><strong>Validação da codificação <code>sexo</code> (CAGED/Base dos Dados):</strong> Confirmar que os valores são 1 = Masculino e 3 = Feminino (não há código 2). O agregado <code>pct_mulher_adm</code> usa <code>sexo == 3</code>.</p>
<div id="c349d573" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conferir codificação de sexo nos microdados CAGED (um ano como amostra)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>_ano_amostra <span class="op">=</span> <span class="dv">2024</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>_path_amostra <span class="op">=</span> DATA_RAW <span class="op">/</span> <span class="ss">f"caged_</span><span class="sc">{</span>_ano_amostra<span class="sc">}</span><span class="ss">.parquet"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> _path_amostra.exists():</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    _ano_amostra <span class="op">=</span> ANO_INICIO</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    _path_amostra <span class="op">=</span> DATA_RAW <span class="op">/</span> <span class="ss">f"caged_</span><span class="sc">{</span>_ano_amostra<span class="sc">}</span><span class="ss">.parquet"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> _path_amostra.exists():</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    _df_sexo <span class="op">=</span> pd.read_parquet(_path_amostra, columns<span class="op">=</span>[<span class="st">"sexo"</span>])</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"sexo — value_counts (ano </span><span class="sc">{</span>_ano_amostra<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(_df_sexo[<span class="st">"sexo"</span>].value_counts().sort_index())</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Esperado: 1 = Masculino, 3 = Feminino (Base dos Dados/CAGED)."</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Nenhum parquet de microdados encontrado para verificar sexo."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sexo — value_counts (ano 2024):
sexo
1    28494836
3    20500968
9         236
Name: count, dtype: int64
  Esperado: 1 = Masculino, 3 = Feminino (Base dos Dados/CAGED).</code></pre>
</div>
</div>
<div id="cea3a3ad" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.3a — Agregação: Microdados → Painel Mensal por Ocupação</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Checkpoint: se o painel já existe, carrega direto.</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> KEEP_PANEL_MENSAL <span class="kw">and</span> PAINEL_MENSAL_FILE.exists():</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    PAINEL_MENSAL_FILE.unlink()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cache removido: </span><span class="sc">{</span>PAINEL_MENSAL_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> PAINEL_MENSAL_FILE.exists():</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    painel <span class="op">=</span> pd.read_parquet(PAINEL_MENSAL_FILE)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Painel carregado do checkpoint: </span><span class="sc">{</span>PAINEL_MENSAL_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span><span class="bu">len</span>(painel)<span class="sc">:,}</span><span class="ss"> linhas, </span><span class="sc">{</span>painel[<span class="st">'cbo_4d'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> ocupações, "</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>painel[<span class="st">'periodo'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> períodos"</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Construindo painel a partir dos microdados (ano a ano)..."</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    paineis_anuais <span class="op">=</span> []</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ano <span class="kw">in</span> <span class="bu">range</span>(ANO_INICIO, ANO_FIM <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Processando </span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">..."</span>, flush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_parquet(DATA_RAW <span class="op">/</span> <span class="ss">f"caged_</span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">.parquet"</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># CBO 4 dígitos</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'cbo_2002'</span>] <span class="op">=</span> df[<span class="st">'cbo_2002'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'cbo_4d'</span>] <span class="op">=</span> df[<span class="st">'cbo_2002'</span>].<span class="bu">str</span>[:<span class="dv">4</span>]</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">'cbo_4d'</span>].<span class="bu">str</span>.<span class="bu">len</span>() <span class="op">==</span> <span class="dv">4</span>]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">'cbo_4d'</span>].<span class="bu">str</span>.isdigit()]</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'cbo_4d'</span>].isin([<span class="st">'0000'</span>])]</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Variáveis temporais</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'periodo'</span>] <span class="op">=</span> df[<span class="st">'ano'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> df[<span class="st">'mes'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">2</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'periodo_num'</span>] <span class="op">=</span> df[<span class="st">'ano'</span>].astype(<span class="bu">int</span>) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> df[<span class="st">'mes'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'post'</span>] <span class="op">=</span> (df[<span class="st">'periodo_num'</span>] <span class="op">&gt;=</span> ANO_TRATAMENTO <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> MES_TRATAMENTO).astype(<span class="bu">int</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flags booleanos (CAGED: sexo 1=Masc, 3=Fem; alinhado à Etapa 1a)</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        CODIGO_SEXO_MULHER <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        CODIGOS_RACA_BRANCA, CODIGOS_RACA_NEGRA <span class="op">=</span> [<span class="dv">1</span>], [<span class="dv">2</span>, <span class="dv">4</span>]</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        IDADE_CORTE_JOVEM <span class="op">=</span> <span class="dv">29</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        CODIGOS_ESCOLARIDADE_SUPERIOR <span class="op">=</span> [<span class="st">'9'</span>, <span class="st">'10'</span>, <span class="st">'11'</span>, <span class="st">'12'</span>, <span class="st">'13'</span>]</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_mulher'</span>] <span class="op">=</span> (df[<span class="st">'sexo'</span>].astype(<span class="bu">str</span>) <span class="op">==</span> <span class="bu">str</span>(CODIGO_SEXO_MULHER)).astype(<span class="bu">float</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        raca_str <span class="op">=</span> df[<span class="st">'raca_cor'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_branco'</span>] <span class="op">=</span> raca_str.isin([<span class="bu">str</span>(c) <span class="cf">for</span> c <span class="kw">in</span> CODIGOS_RACA_BRANCA]).astype(<span class="bu">float</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_negro'</span>] <span class="op">=</span> raca_str.isin([<span class="bu">str</span>(c) <span class="cf">for</span> c <span class="kw">in</span> CODIGOS_RACA_NEGRA]).astype(<span class="bu">float</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_jovem'</span>] <span class="op">=</span> (df[<span class="st">'idade'</span>] <span class="op">&lt;=</span> IDADE_CORTE_JOVEM).astype(<span class="bu">float</span>)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_superior'</span>] <span class="op">=</span> df[<span class="st">'grau_instrucao'</span>].astype(<span class="bu">str</span>).isin(CODIGOS_ESCOLARIDADE_SUPERIOR).astype(<span class="bu">float</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Setor tecnológico (CNAE 2.0 seção: J = Informação e comunicação, etc.)</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_setor_tech'</span>] <span class="op">=</span> df[<span class="st">'cnae_2_secao'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().isin(CNAE_SECOES_TECNOLOGICO).astype(<span class="bu">float</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Separar admissões e desligamentos</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        df_adm <span class="op">=</span> df[df[<span class="st">'saldo_movimentacao'</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>        df_desl <span class="op">=</span> df[df[<span class="st">'saldo_movimentacao'</span>] <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>ano<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df_adm)<span class="sc">:,}</span><span class="ss"> admissões, </span><span class="sc">{</span><span class="bu">len</span>(df_desl)<span class="sc">:,}</span><span class="ss"> desligamentos"</span>, flush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Colunas de salário mascaradas (média condicional por grupo)</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_mulher'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_mulher'</span>] <span class="op">==</span> <span class="dv">1</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_homem'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_mulher'</span>] <span class="op">==</span> <span class="dv">0</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_branco'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_branco'</span>] <span class="op">==</span> <span class="dv">1</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_negro'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_negro'</span>] <span class="op">==</span> <span class="dv">1</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_jovem'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_jovem'</span>] <span class="op">==</span> <span class="dv">1</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_naojovem'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_jovem'</span>] <span class="op">==</span> <span class="dv">0</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_sup'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_superior'</span>] <span class="op">==</span> <span class="dv">1</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'sal_med'</span>] <span class="op">=</span> np.where(df_adm[<span class="st">'is_superior'</span>] <span class="op">==</span> <span class="dv">0</span>, df_adm[<span class="st">'salario_mensal'</span>], np.nan)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>        df_adm[<span class="st">'is_homem'</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> df_adm[<span class="st">'is_mulher'</span>]</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Agregar admissões + heterogeneidade demográfica</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>        painel_adm <span class="op">=</span> df_adm.groupby([<span class="st">'cbo_4d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>]).agg(</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>            admissoes<span class="op">=</span>(<span class="st">'saldo_movimentacao'</span>, <span class="st">'count'</span>),</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>            salario_medio_adm<span class="op">=</span>(<span class="st">'salario_mensal'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>            idade_media_adm<span class="op">=</span>(<span class="st">'idade'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>            pct_mulher_adm<span class="op">=</span>(<span class="st">'is_mulher'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>            pct_superior_adm<span class="op">=</span>(<span class="st">'is_superior'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>            pct_branco_adm<span class="op">=</span>(<span class="st">'is_branco'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>            pct_negro_adm<span class="op">=</span>(<span class="st">'is_negro'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>            pct_jovem_adm<span class="op">=</span>(<span class="st">'is_jovem'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>            pct_tecnologico_adm<span class="op">=</span>(<span class="st">'is_setor_tech'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>            salario_medio_mulher<span class="op">=</span>(<span class="st">'sal_mulher'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>            salario_medio_homem<span class="op">=</span>(<span class="st">'sal_homem'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>            salario_medio_branco<span class="op">=</span>(<span class="st">'sal_branco'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>            salario_medio_negro<span class="op">=</span>(<span class="st">'sal_negro'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>            salario_medio_jovem<span class="op">=</span>(<span class="st">'sal_jovem'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>            salario_medio_naojovem<span class="op">=</span>(<span class="st">'sal_naojovem'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>            salario_medio_superior<span class="op">=</span>(<span class="st">'sal_sup'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>            salario_medio_medio<span class="op">=</span>(<span class="st">'sal_med'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>            admissoes_mulher<span class="op">=</span>(<span class="st">'is_mulher'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>            admissoes_homem<span class="op">=</span>(<span class="st">'is_homem'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>            admissoes_jovem<span class="op">=</span>(<span class="st">'is_jovem'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>            admissoes_negro<span class="op">=</span>(<span class="st">'is_negro'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>        ).reset_index()</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mediana separada (performance)</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>        mediana <span class="op">=</span> df_adm.groupby([<span class="st">'cbo_4d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>])[<span class="st">'salario_mensal'</span>].median().reset_index()</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>        mediana.columns <span class="op">=</span> [<span class="st">'cbo_4d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>, <span class="st">'salario_mediano_adm'</span>]</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>        painel_adm <span class="op">=</span> painel_adm.merge(mediana, on<span class="op">=</span>[<span class="st">'cbo_4d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Agregar desligamentos</span></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>        painel_desl <span class="op">=</span> df_desl.groupby([<span class="st">'cbo_4d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>]).agg(</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>            desligamentos<span class="op">=</span>(<span class="st">'saldo_movimentacao'</span>, <span class="st">'count'</span>),</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>            salario_medio_desl<span class="op">=</span>(<span class="st">'salario_mensal'</span>, <span class="st">'mean'</span>),</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>        ).reset_index()</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge</span></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> painel_adm.merge(painel_desl, on<span class="op">=</span>[<span class="st">'cbo_4d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>], how<span class="op">=</span><span class="st">'outer'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'saldo'</span>] <span class="op">=</span> p[<span class="st">'admissoes'</span>] <span class="op">-</span> p[<span class="st">'desligamentos'</span>]</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'n_movimentacoes'</span>] <span class="op">=</span> p[<span class="st">'admissoes'</span>] <span class="op">+</span> p[<span class="st">'desligamentos'</span>]</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'setor_tecnologico'</span>] <span class="op">=</span> (p[<span class="st">'pct_tecnologico_adm'</span>] <span class="op">&gt;=</span> SETOR_TECNOLOGICO_LIMIAR).astype(<span class="bu">int</span>)</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'periodo'</span>] <span class="op">=</span> p[<span class="st">'ano'</span>].astype(<span class="bu">int</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> p[<span class="st">'mes'</span>].astype(<span class="bu">int</span>).astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">2</span>)</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'periodo_num'</span>] <span class="op">=</span> p[<span class="st">'ano'</span>].astype(<span class="bu">int</span>) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> p[<span class="st">'mes'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'post'</span>] <span class="op">=</span> (p[<span class="st">'periodo_num'</span>] <span class="op">&gt;=</span> ANO_TRATAMENTO <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> MES_TRATAMENTO).astype(<span class="bu">int</span>)</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'ln_admissoes'</span>] <span class="op">=</span> np.log(p[<span class="st">'admissoes'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'ln_desligamentos'</span>] <span class="op">=</span> np.log(p[<span class="st">'desligamentos'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'ln_salario_adm'</span>] <span class="op">=</span> np.log(p[<span class="st">'salario_medio_adm'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>        p[<span class="st">'cbo_2d'</span>] <span class="op">=</span> p[<span class="st">'cbo_4d'</span>].<span class="bu">str</span>[:<span class="dv">2</span>]</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Logs de heterogeneidade (salários e admissões por grupo)</span></span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'mulher'</span>, <span class="st">'homem'</span>, <span class="st">'branco'</span>, <span class="st">'negro'</span>, <span class="st">'jovem'</span>, <span class="st">'naojovem'</span>, <span class="st">'superior'</span>, <span class="st">'medio'</span>]:</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>            col <span class="op">=</span> <span class="ss">f'salario_medio_</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> p.columns:</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>                p[<span class="ss">f'ln_salario_</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> np.log(p[col].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'mulher'</span>, <span class="st">'homem'</span>, <span class="st">'jovem'</span>, <span class="st">'negro'</span>]:</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>            col <span class="op">=</span> <span class="ss">f'admissoes_</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> p.columns:</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>                p[<span class="ss">f'ln_admissoes_</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> np.log(p[col].astype(<span class="bu">float</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>        paineis_anuais.append(p)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    → </span><span class="sc">{</span><span class="bu">len</span>(p)<span class="sc">:,}</span><span class="ss"> linhas no painel"</span>, flush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    painel <span class="op">=</span> pd.concat(paineis_anuais, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>    painel.to_parquet(PAINEL_MENSAL_FILE, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Painel salvo: </span><span class="sc">{</span>PAINEL_MENSAL_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Painel final: </span><span class="sc">{</span><span class="bu">len</span>(painel)<span class="sc">:,}</span><span class="ss"> linhas"</span>)</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Ocupações: </span><span class="sc">{</span>painel[<span class="st">'cbo_4d'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">, Períodos: </span><span class="sc">{</span>painel[<span class="st">'periodo'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Shape: </span><span class="sc">{</span>painel<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Painel carregado do checkpoint: painel_caged_mensal.parquet
  32,988 linhas, 629 ocupações, 54 períodos

Painel final: 32,988 linhas
  Ocupações: 629, Períodos: 54
  Shape: (32988, 49)</code></pre>
</div>
</div>
</section>
</section>
<section id="b.-verificar-painel-agregado-checkpoint" class="level3" data-number="0.10">
<h3 data-number="0.10" class="anchored" data-anchor-id="b.-verificar-painel-agregado-checkpoint"><span class="header-section-number">0.10</span> 3b. Verificar painel agregado (CHECKPOINT)</h3>
<p>Verificar integridade do painel: dimensões, balanceamento (ocupações × períodos), cobertura temporal, distribuição de variáveis-chave e série temporal agregada.</p>
<div id="f3b53806" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.3b — CHECKPOINT: Verificar painel agregado</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CHECKPOINT — Painel Ocupação × Mês"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Dimensões</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>n_ocup <span class="op">=</span> painel[<span class="st">'cbo_4d'</span>].nunique()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>n_periodos <span class="op">=</span> painel[<span class="st">'periodo'</span>].nunique()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Ocupações: </span><span class="sc">{</span>n_ocup<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Períodos: </span><span class="sc">{</span>n_periodos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Painel teórico (balanceado): </span><span class="sc">{</span>n_ocup <span class="op">*</span> n_periodos<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Painel real: </span><span class="sc">{</span><span class="bu">len</span>(painel)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Balanceamento: </span><span class="sc">{</span><span class="bu">len</span>(painel) <span class="op">/</span> (n_ocup <span class="op">*</span> n_periodos)<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Ocupações com poucos meses</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>ocup_meses <span class="op">=</span> painel.groupby(<span class="st">'cbo_4d'</span>)[<span class="st">'periodo'</span>].nunique()</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Meses por ocupação:"</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Min: </span><span class="sc">{</span>ocup_meses<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, Max: </span><span class="sc">{</span>ocup_meses<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, Média: </span><span class="sc">{</span>ocup_meses<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Ocupações com &lt; 12 meses: </span><span class="sc">{</span>(ocup_meses <span class="op">&lt;</span> <span class="dv">12</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Ocupações com todos os </span><span class="sc">{</span>n_periodos<span class="sc">}</span><span class="ss"> meses: </span><span class="sc">{</span>(ocup_meses <span class="op">==</span> n_periodos)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Estatísticas descritivas</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Estatísticas descritivas:"</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(painel[[<span class="st">'admissoes'</span>, <span class="st">'desligamentos'</span>, <span class="st">'saldo'</span>, <span class="st">'salario_medio_adm'</span>]].describe().<span class="bu">round</span>(<span class="dv">1</span>))</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Série temporal agregada</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> painel.groupby(<span class="st">'periodo_num'</span>).agg(</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    total_adm<span class="op">=</span>(<span class="st">'admissoes'</span>, <span class="st">'sum'</span>),</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    total_desl<span class="op">=</span>(<span class="st">'desligamentos'</span>, <span class="st">'sum'</span>),</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    sal_medio<span class="op">=</span>(<span class="st">'salario_medio_adm'</span>, <span class="st">'mean'</span>),</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Série temporal (primeiros e últimos 3 meses):"</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ts.head(<span class="dv">3</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"..."</span>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ts.tail(<span class="dv">3</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
CHECKPOINT — Painel Ocupação × Mês
============================================================

Ocupações: 629
Períodos: 54
Painel teórico (balanceado): 33,966
Painel real: 32,988
Balanceamento: 97.1%

Meses por ocupação:
  Min: 2, Max: 54, Média: 52.4
  Ocupações com &lt; 12 meses: 9
  Ocupações com todos os 54 meses: 589

Estatísticas descritivas:
       admissoes  desligamentos    saldo  salario_medio_adm
count    32988.0        32988.0  32988.0            32988.0
mean      3153.5         2873.6    279.9             6131.1
std      13880.0        12450.5   2323.0           158475.4
min          0.0            0.0 -46650.0                0.0
25%         60.0           60.0    -16.0             1782.8
50%        293.0          289.0      7.0             2371.3
75%       1338.0         1264.0    107.0             3811.2
max     289900.0       284338.0  90556.0         18799538.2

Série temporal (primeiros e últimos 3 meses):
 periodo_num  total_adm  total_desl   sal_medio
      202101    1550075     1293016 3697.157086
      202102    1715425     1317510 3723.743109
      202103    1626885     1450555 3252.934263
...
 periodo_num  total_adm  total_desl    sal_medio
      202504    2282187     2024659  4011.260301
      202505    2256225     2107233  4441.730675
      202506    2139182     1972561 11519.380585</code></pre>
</div>
</div>
<section id="verificação-outlier-salarial-em-jun2025" class="level4" data-number="0.10.1">
<h4 data-number="0.10.1" class="anchored" data-anchor-id="verificação-outlier-salarial-em-jun2025"><span class="header-section-number">0.10.1</span> Verificação: outlier salarial em Jun/2025</h4>
<p>A série temporal agregada no checkpoint acima pode mostrar salário médio elevado em Jun/2025 (~3× os meses anteriores). Abaixo verificamos se isso reflete <strong>(i)</strong> poucas células ocupação×mês com salário muito alto e/ou poucas movimentações, <strong>(ii)</strong> possível publicação parcial do mês, ou <strong>(iii)</strong> padrão real dos dados. Conforme o diagnóstico, pode-se documentar, filtrar células com poucas movimentações ou truncar a janela em Mai/2025.</p>
<div id="713ec067" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnóstico: Jun/2025 — distribuição de salario_medio_adm e células extremas</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>jun <span class="op">=</span> painel[painel[<span class="st">'periodo_num'</span>] <span class="op">==</span> <span class="dv">202506</span>].copy()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Jun/2025 — Distribuição de salario_medio_adm (células ocupação×mês):"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(jun[<span class="st">'salario_medio_adm'</span>].describe(percentiles<span class="op">=</span>[<span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span>]).<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Células com poucas movimentações e salário alto</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>limiar_mov <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>limiar_sal <span class="op">=</span> <span class="dv">10_000</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>mask_extremo <span class="op">=</span> (jun[<span class="st">'n_movimentacoes'</span>] <span class="op">&lt;</span> limiar_mov) <span class="op">&amp;</span> (jun[<span class="st">'salario_medio_adm'</span>] <span class="op">&gt;</span> limiar_sal)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>n_extremo <span class="op">=</span> mask_extremo.<span class="bu">sum</span>()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>adm_jun_total <span class="op">=</span> jun[<span class="st">'admissoes'</span>].<span class="bu">sum</span>()</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>adm_extremo <span class="op">=</span> jun.loc[mask_extremo, <span class="st">'admissoes'</span>].<span class="bu">sum</span>()</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Células com n_movimentacoes &lt; </span><span class="sc">{</span>limiar_mov<span class="sc">}</span><span class="ss"> e salario_medio_adm &gt; R$ </span><span class="sc">{</span>limiar_sal<span class="sc">:,.0f}</span><span class="ss">: </span><span class="sc">{</span>n_extremo<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Admissões nessas células: </span><span class="sc">{</span>adm_extremo<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>adm_extremo<span class="op">/</span>adm_jun_total<span class="sc">:.2f}</span><span class="ss">% do total de Jun/2025)"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_extremo <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(jun.loc[mask_extremo, [<span class="st">'cbo_4d'</span>, <span class="st">'admissoes'</span>, <span class="st">'n_movimentacoes'</span>, <span class="st">'salario_medio_adm'</span>]].sort_values(<span class="st">'salario_medio_adm'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">15</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparação com Mai/2025 e média 2025</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>mai <span class="op">=</span> painel[painel[<span class="st">'periodo_num'</span>] <span class="op">==</span> <span class="dv">202505</span>]</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>ano2025 <span class="op">=</span> painel[painel[<span class="st">'periodo_num'</span>] <span class="op">//</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Comparativo 2025:"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mai/2025: células=</span><span class="sc">{</span><span class="bu">len</span>(mai)<span class="sc">}</span><span class="ss">, total_adm=</span><span class="sc">{</span>mai[<span class="st">'admissoes'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,.0f}</span><span class="ss">, sal_medio(agg)=</span><span class="sc">{</span>mai[<span class="st">'salario_medio_adm'</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Jun/2025: células=</span><span class="sc">{</span><span class="bu">len</span>(jun)<span class="sc">}</span><span class="ss">, total_adm=</span><span class="sc">{</span>adm_jun_total<span class="sc">:,.0f}</span><span class="ss">, sal_medio(agg)=</span><span class="sc">{</span>jun[<span class="st">'salario_medio_adm'</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Média mensal 2025: células~</span><span class="sc">{</span><span class="bu">len</span>(ano2025)<span class="op">//</span><span class="dv">12</span><span class="sc">:.0f}</span><span class="ss">, total_adm~</span><span class="sc">{</span>ano2025<span class="sc">.</span>groupby(<span class="st">'periodo_num'</span>)[<span class="st">'admissoes'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Jun/2025 — Distribuição de salario_medio_adm (células ocupação×mês):
count        615.00
mean       11519.38
std       170295.09
min            0.00
50%         2647.30
90%         7652.32
95%        10449.24
99%        38462.94
max      4216672.39
Name: salario_medio_adm, dtype: float64

Células com n_movimentacoes &lt; 50 e salario_medio_adm &gt; R$ 10,000: 9
  Admissões nessas células: 125 (0.01% do total de Jun/2025)
cbo_4d  admissoes  n_movimentacoes  salario_medio_adm
  2423          1                1       80466.670000
  1237         22               48       43743.163182
  1222         19               49       41853.112105
  1234         15               36       38843.381333
  1221          6               15       35815.645000
  1223         19               36       14490.656842
  2422          1                1       14097.220000
  2622         24               48       12752.264583
  1031         18               20       10953.792222

Comparativo 2025:
  Mai/2025: células=614, total_adm=2,256,225, sal_medio(agg)=4,442
  Jun/2025: células=615, total_adm=2,139,182, sal_medio(agg)=11,519
  Média mensal 2025: células~306, total_adm~2,293,843</code></pre>
</div>
</div>
</section>
</section>
<section id="a.-crosswalk-cbo-2002-isco-08" class="level3" data-number="0.11">
<h3 data-number="0.11" class="anchored" data-anchor-id="a.-crosswalk-cbo-2002-isco-08"><span class="header-section-number">0.11</span> 4a. Crosswalk CBO 2002 → ISCO-08</h3>
<p>Mapear os códigos CBO 2002 (usados no CAGED) para ISCO-08 (usados no índice ILO). <strong>Esta é a etapa metodologicamente mais delicada do pipeline.</strong></p>
<section id="contexto" class="level4" data-number="0.11.1">
<h4 data-number="0.11.1" class="anchored" data-anchor-id="contexto"><span class="header-section-number">0.11.1</span> Contexto</h4>
<p>A CBO 2002 foi construída com base na ISCO-88/ISCO-08, compartilhando a mesma estrutura hierárquica:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 25%">
<col style="width: 23%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Nível</th>
<th>CBO 2002</th>
<th>ISCO-08</th>
<th>Alinhamento</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1 dígito</td>
<td>Grande Grupo (10)</td>
<td>Major Group (10)</td>
<td>Perfeito</td>
</tr>
<tr class="even">
<td>2 dígitos</td>
<td>Subgrupo Principal (~46)</td>
<td>Sub-major Group (43)</td>
<td>Bom (14 CBOs sem match direto)</td>
</tr>
<tr class="odd">
<td>3 dígitos</td>
<td>Subgrupo (~194)</td>
<td>Minor Group (130)</td>
<td>Parcial (~45% direto)</td>
</tr>
<tr class="even">
<td>4 dígitos</td>
<td>Família (~629)</td>
<td>Unit Group (427)</td>
<td>Divergente (~28% direto)</td>
</tr>
</tbody>
</table>
</section>
<section id="estratégia-adotada-dual-2d-principal-4d-robustez" class="level4" data-number="0.11.2">
<h4 data-number="0.11.2" class="anchored" data-anchor-id="estratégia-adotada-dual-2d-principal-4d-robustez"><span class="header-section-number">0.11.2</span> Estratégia adotada: Dual (2d principal + 4d robustez)</h4>
<p><strong>PARTE A — Especificação PRINCIPAL (2 dígitos):</strong> - CBO 2d → ISCO-08 Sub-major Group (match direto) - Fallback: CBO 1d → ISCO-08 Major Group (média) - Cobertura esperada: <strong>100%</strong></p>
<p><strong>PARTE B — Especificação de ROBUSTEZ (4 dígitos, fallback hierárquico em 6 níveis):</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 30%">
<col style="width: 51%">
</colgroup>
<thead>
<tr class="header">
<th>Nível</th>
<th>Estratégia</th>
<th>Cobertura esperada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>N1</td>
<td>CBO 4d = ISCO-08 4d (match direto)</td>
<td>~28%</td>
</tr>
<tr class="even">
<td>N2</td>
<td>CBO 4d = ISCO-88 4d → ISCO-08 via correspondência oficial</td>
<td>~+9%</td>
</tr>
<tr class="odd">
<td>N3</td>
<td>CBO 3d = ISCO-08 3d (média Minor Group)</td>
<td>~+20%</td>
</tr>
<tr class="even">
<td>N4</td>
<td>CBO 3d = ISCO-88 3d → ISCO-08 via correspondência</td>
<td>~+1%</td>
</tr>
<tr class="odd">
<td>N5</td>
<td>CBO 2d = ISCO-08 2d (= especificação principal)</td>
<td>~+18%</td>
</tr>
<tr class="even">
<td>N6</td>
<td>CBO 1d = ISCO-08 1d (média Major Group)</td>
<td>~+24%</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><strong>Nota — Muendler (CBO 1994):</strong> O arquivo <code>cbo-isco-conc.csv</code> de Muendler &amp; Poole (2004) mapeia CBO <strong>1994</strong> → ISCO-88, NÃO a CBO 2002 usada no CAGED. Por isso, o match 4d via Muendler é limitado. A estratégia principal utiliza a similaridade estrutural entre CBO 2002 e ISCO-08/88 com fallback hierárquico.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Nota sobre atenuação:</strong> Se o crosswalk a 4 dígitos introduz erro de medição, o efeito típico é <strong>atenuação</strong> (viés em direção a zero). Encontrar efeito significativo mesmo com erro de medição sugere que o efeito real é provavelmente maior.</p>
</blockquote>
<p><strong>Validação do crosswalk:</strong> O notebook não usa Muendler para o match principal; utiliza a correspondência oficial ISCO-08↔︎88 e fallback hierárquico. Na especificação 2d: match direto CBO 2d → ISCO-08 Sub-major Group, com fallback a 1 dígito (Major Group). Na 4d: fallback em 6 níveis (N1→N6). Resultado verificado: cobertura 100% em 2d e 4d, correlação entre exposure_score_2d e exposure_score_4d ~0,915 — consistente com o planejamento e pronto para o DiD no Notebook 2b.</p>
<div id="5fdb8d1d" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.4a — Crosswalk CBO 2002 → ISCO-08 (Dual: 2d principal + 4d robustez)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Checkpoint: se o painel com crosswalk já existe, carrega direto.</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> KEEP_PANEL_CROSSWALK <span class="kw">and</span> PAINEL_CROSSWALK_FILE.exists():</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    PAINEL_CROSSWALK_FILE.unlink()</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cache removido: </span><span class="sc">{</span>PAINEL_CROSSWALK_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> PAINEL_CROSSWALK_FILE.exists():</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    painel <span class="op">=</span> pd.read_parquet(PAINEL_CROSSWALK_FILE)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Crosswalk carregado do checkpoint: </span><span class="sc">{</span>PAINEL_CROSSWALK_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span><span class="bu">len</span>(painel)<span class="sc">:,}</span><span class="ss"> linhas, cobertura 2d: </span><span class="sc">{</span>painel[<span class="st">'exposure_score_2d'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">, "</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"4d: </span><span class="sc">{</span>painel[<span class="st">'exposure_score_4d'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Carregar dados de referência</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    df_ilo <span class="op">=</span> pd.read_csv(ILO_FILE)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    df_ilo[<span class="st">'isco_08_str'</span>] <span class="op">=</span> df_ilo[<span class="st">'isco_08'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Índice ILO carregado: </span><span class="sc">{</span><span class="bu">len</span>(df_ilo)<span class="sc">}</span><span class="ss"> ocupações ISCO-08"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Score range: [</span><span class="sc">{</span>df_ilo[<span class="st">'exposure_score'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>df_ilo[<span class="st">'exposure_score'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.3f}</span><span class="ss">]"</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dicts ILO em múltiplos níveis</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    codes <span class="op">=</span> df_ilo[<span class="st">'isco_08_str'</span>]</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    ilo_4d <span class="op">=</span> df_ilo.groupby(<span class="st">'isco_08_str'</span>)[<span class="st">'exposure_score'</span>].mean().to_dict()</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    ilo_3d <span class="op">=</span> df_ilo.assign(g<span class="op">=</span>codes.<span class="bu">str</span>[:<span class="dv">3</span>]).groupby(<span class="st">'g'</span>)[<span class="st">'exposure_score'</span>].mean().to_dict()</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    ilo_2d <span class="op">=</span> df_ilo.assign(g<span class="op">=</span>codes.<span class="bu">str</span>[:<span class="dv">2</span>]).groupby(<span class="st">'g'</span>)[<span class="st">'exposure_score'</span>].mean().to_dict()</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    ilo_1d <span class="op">=</span> df_ilo.assign(g<span class="op">=</span>codes.<span class="bu">str</span>[:<span class="dv">1</span>]).groupby(<span class="st">'g'</span>)[<span class="st">'exposure_score'</span>].mean().to_dict()</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correspondência ISCO-08 ↔ ISCO-88 (arquivo local)</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    isco88_to_08 <span class="op">=</span> {}</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    isco88_3d_to_08_3d <span class="op">=</span> {}</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ISCO_08_88_FILE.exists():</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        df_corr <span class="op">=</span> pd.read_excel(ISCO_08_88_FILE, sheet_name<span class="op">=</span><span class="st">'ISCO-08 to 88'</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        df_corr[<span class="st">'isco08_4d'</span>] <span class="op">=</span> df_corr[<span class="st">'ISCO-08 code'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        df_corr[<span class="st">'isco88_4d'</span>] <span class="op">=</span> df_corr[<span class="st">'ISCO-88 code'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        isco88_to_08 <span class="op">=</span> df_corr.groupby(<span class="st">'isco88_4d'</span>)[<span class="st">'isco08_4d'</span>].<span class="bu">apply</span>(<span class="bu">list</span>).to_dict()</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        df_corr[<span class="st">'isco88_3d'</span>] <span class="op">=</span> df_corr[<span class="st">'isco88_4d'</span>].<span class="bu">str</span>[:<span class="dv">3</span>]</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        df_corr[<span class="st">'isco08_3d'</span>] <span class="op">=</span> df_corr[<span class="st">'isco08_4d'</span>].<span class="bu">str</span>[:<span class="dv">3</span>]</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        isco88_3d_to_08_3d <span class="op">=</span> df_corr.groupby(<span class="st">'isco88_3d'</span>)[<span class="st">'isco08_3d'</span>].<span class="bu">apply</span>(</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">list</span>(<span class="bu">set</span>(x))).to_dict()</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Correspondência ISCO-08↔88: </span><span class="sc">{</span><span class="bu">len</span>(df_corr)<span class="sc">}</span><span class="ss"> mapeamentos"</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PARTE A: 2 dígitos (PRINCIPAL)</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ch">\n</span><span class="ss">PARTE A: Crosswalk 2 dígitos (PRINCIPAL)</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'exposure_score_2d'</span>] <span class="op">=</span> painel[<span class="st">'cbo_2d'</span>].<span class="bu">map</span>(ilo_2d)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'match_level_2d'</span>] <span class="op">=</span> np.where(painel[<span class="st">'exposure_score_2d'</span>].notna(), <span class="st">'2-digit'</span>, <span class="va">None</span>)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback a 1 dígito</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    mask_na <span class="op">=</span> painel[<span class="st">'exposure_score_2d'</span>].isna()</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask_na.<span class="bu">any</span>():</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>        cbo_1d <span class="op">=</span> painel.loc[mask_na, <span class="st">'cbo_4d'</span>].<span class="bu">str</span>[:<span class="dv">1</span>]</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        painel.loc[mask_na, <span class="st">'exposure_score_2d'</span>] <span class="op">=</span> cbo_1d.<span class="bu">map</span>(ilo_1d).values</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>        painel.loc[mask_na, <span class="st">'match_level_2d'</span>] <span class="op">=</span> <span class="st">'1-digit (fallback)'</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'exposure_score'</span>] <span class="op">=</span> painel[<span class="st">'exposure_score_2d'</span>]</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    cov_2d <span class="op">=</span> painel[<span class="st">'exposure_score_2d'</span>].notna().mean()</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  COBERTURA 2d: </span><span class="sc">{</span>cov_2d<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lvl, cnt <span class="kw">in</span> painel[<span class="st">'match_level_2d'</span>].value_counts().items():</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>lvl<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>cnt<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>cnt<span class="op">/</span><span class="bu">len</span>(painel)<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PARTE B: 4 dígitos (ROBUSTEZ) — fallback hierárquico 6 níveis</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ch">\n</span><span class="ss">PARTE B: Crosswalk 4 dígitos (ROBUSTEZ)</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    cbos_unicos <span class="op">=</span> <span class="bu">sorted</span>(painel[<span class="st">'cbo_4d'</span>].unique())</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    cbo_score_4d <span class="op">=</span> {}</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    cbo_match_level <span class="op">=</span> {}</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> {<span class="st">'N1'</span>: <span class="dv">0</span>, <span class="st">'N2'</span>: <span class="dv">0</span>, <span class="st">'N3'</span>: <span class="dv">0</span>, <span class="st">'N4'</span>: <span class="dv">0</span>, <span class="st">'N5'</span>: <span class="dv">0</span>, <span class="st">'N6'</span>: <span class="dv">0</span>, <span class="st">'sem'</span>: <span class="dv">0</span>}</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cbo <span class="kw">in</span> cbos_unicos:</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>        score, level <span class="op">=</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N1: CBO 4d = ISCO-08 4d</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cbo <span class="kw">in</span> ilo_4d:</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>            score, level <span class="op">=</span> ilo_4d[cbo], <span class="st">'N1: ISCO-08 4d direto'</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>            counts[<span class="st">'N1'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N2: CBO 4d = ISCO-88 4d → ISCO-08</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> cbo <span class="kw">in</span> isco88_to_08:</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>            scores_c <span class="op">=</span> [ilo_4d[c] <span class="cf">for</span> c <span class="kw">in</span> isco88_to_08[cbo] <span class="cf">if</span> c <span class="kw">in</span> ilo_4d]</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> scores_c:</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>                score, level <span class="op">=</span> np.mean(scores_c), <span class="st">'N2: via ISCO-88→08 4d'</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>                counts[<span class="st">'N2'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N3: CBO 3d = ISCO-08 3d</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> cbo[:<span class="dv">3</span>] <span class="kw">in</span> ilo_3d:</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>            score, level <span class="op">=</span> ilo_3d[cbo[:<span class="dv">3</span>]], <span class="st">'N3: ISCO-08 3d'</span></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>            counts[<span class="st">'N3'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N4: CBO 3d = ISCO-88 3d → ISCO-08 3d</span></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> cbo[:<span class="dv">3</span>] <span class="kw">in</span> isco88_3d_to_08_3d:</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>            scores_c <span class="op">=</span> [ilo_3d[c] <span class="cf">for</span> c <span class="kw">in</span> isco88_3d_to_08_3d[cbo[:<span class="dv">3</span>]] <span class="cf">if</span> c <span class="kw">in</span> ilo_3d]</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> scores_c:</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>                score, level <span class="op">=</span> np.mean(scores_c), <span class="st">'N4: via ISCO-88→08 3d'</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>                counts[<span class="st">'N4'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N5: CBO 2d = ISCO-08 2d</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> cbo[:<span class="dv">2</span>] <span class="kw">in</span> ilo_2d:</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>            score, level <span class="op">=</span> ilo_2d[cbo[:<span class="dv">2</span>]], <span class="st">'N5: ISCO-08 2d'</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>            counts[<span class="st">'N5'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N6: CBO 1d = ISCO-08 1d</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> cbo[:<span class="dv">1</span>] <span class="kw">in</span> ilo_1d:</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>            score, level <span class="op">=</span> ilo_1d[cbo[:<span class="dv">1</span>]], <span class="st">'N6: ISCO-08 1d'</span></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>            counts[<span class="st">'N6'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>            cbo_score_4d[cbo] <span class="op">=</span> score</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>            cbo_match_level[cbo] <span class="op">=</span> level</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>            counts[<span class="st">'sem'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'exposure_score_4d'</span>] <span class="op">=</span> painel[<span class="st">'cbo_4d'</span>].<span class="bu">map</span>(cbo_score_4d)</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'match_level_4d'</span>] <span class="op">=</span> painel[<span class="st">'cbo_4d'</span>].<span class="bu">map</span>(cbo_match_level)</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="bu">len</span>(cbos_unicos)</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CBOs 4d únicos: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> counts.items():</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>v<span class="op">/</span>total<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  COBERTURA 4d: </span><span class="sc">{</span>painel[<span class="st">'exposure_score_4d'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correlação 2d vs 4d</span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>    df_check <span class="op">=</span> painel[[<span class="st">'cbo_4d'</span>, <span class="st">'exposure_score_2d'</span>, <span class="st">'exposure_score_4d'</span>]].drop_duplicates(<span class="st">'cbo_4d'</span>)</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> df_check[<span class="st">'exposure_score_2d'</span>].corr(df_check[<span class="st">'exposure_score_4d'</span>])</span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Correlação Pearson (2d vs 4d): </span><span class="sc">{</span>corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>    painel.to_parquet(PAINEL_CROSSWALK_FILE, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Salvo: </span><span class="sc">{</span>PAINEL_CROSSWALK_FILE<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Crosswalk carregado do checkpoint: painel_caged_crosswalk.parquet
  32,988 linhas, cobertura 2d: 100.0%, 4d: 100.0%</code></pre>
</div>
</div>
<p><strong>CBOs 2 dígitos sem match direto em ISCO-08:</strong> Subgrupos principais CBO que não possuem equivalente direto em Sub-major Group ISCO-08; recebem score via fallback a 1 dígito (Major Group). Lista abaixo (a partir do painel com crosswalk).</p>
<div id="7a414cab" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Listar CBO 2d que caem no fallback a 1 dígito (sem match direto em ISCO-08 Sub-major Group)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'match_level_2d'</span> <span class="kw">in</span> painel.columns:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    fallback_2d <span class="op">=</span> painel[painel[<span class="st">'match_level_2d'</span>] <span class="op">==</span> <span class="st">'1-digit (fallback)'</span>][<span class="st">'cbo_2d'</span>].unique()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    fallback_2d <span class="op">=</span> <span class="bu">sorted</span>(fallback_2d)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"CBOs 2d sem match direto (fallback a Major Group): </span><span class="sc">{</span><span class="bu">len</span>(fallback_2d)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Códigos:"</span>, fallback_2d)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Opcional: exemplos de cbo_4d por um desses 2d</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(fallback_2d) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        ex <span class="op">=</span> painel[painel[<span class="st">'cbo_2d'</span>] <span class="op">==</span> fallback_2d[<span class="dv">0</span>]][[<span class="st">'cbo_2d'</span>, <span class="st">'cbo_4d'</span>]].drop_duplicates()</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Exemplo (cbo_2d=</span><span class="sc">{</span>fallback_2d[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">): cbo_4d presentes: </span><span class="sc">{</span>ex[<span class="st">'cbo_4d'</span>]<span class="sc">.</span>tolist()[:<span class="dv">8</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Coluna match_level_2d não encontrada (crosswalk pode ter sido carregado sem essa coluna)."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CBOs 2d sem match direto (fallback a Major Group): 14
Códigos: ['10', '20', '27', '30', '37', '39', '64', '76', '77', '78', '79', '84', '86', '99']

Exemplo (cbo_2d=10): cbo_4d presentes: ['1010', '1011', '1020', '1021', '1030', '1031']...</code></pre>
</div>
</div>
</section>
</section>
<section id="b.-verificar-crosswalk-checkpoint" class="level3" data-number="0.12">
<h3 data-number="0.12" class="anchored" data-anchor-id="b.-verificar-crosswalk-checkpoint"><span class="header-section-number">0.12</span> 4b. Verificar crosswalk (CHECKPOINT)</h3>
<p>Validar qualidade do crosswalk nas DUAS especificações: principal (2 dígitos) e robustez (4 dígitos). Verificar cobertura, distribuição de scores, correlação entre especificações e sanity check por grande grupo CBO.</p>
<p><strong>Critérios de aceite:</strong> - Cobertura 2d ≥ 95% (esperado ~100%) - Cobertura 4d ≥ 80% (esperado ~100% com fallback) - Correlação 2d vs 4d &gt; 0.8 (consistência entre especificações)</p>
<div id="de59ed6d" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.4b — CHECKPOINT: Verificar crosswalk CBO → ISCO-08</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CHECKPOINT — Crosswalk CBO → ISCO-08 (Dual)"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Cobertura</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>coverage_2d <span class="op">=</span> painel[<span class="st">'exposure_score_2d'</span>].notna().mean()</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>coverage_4d <span class="op">=</span> painel[<span class="st">'exposure_score_4d'</span>].notna().mean()</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Cobertura ---"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  2 dígitos (PRINCIPAL): </span><span class="sc">{</span>coverage_2d<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  4 dígitos (ROBUSTEZ):  </span><span class="sc">{</span>coverage_4d<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> coverage_2d <span class="op">&lt;</span> <span class="fl">0.95</span>:</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  ALERTA: Cobertura 2d abaixo de 95%!"</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> coverage_4d <span class="op">&lt;</span> <span class="fl">0.80</span>:</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  AVISO: Cobertura 4d abaixo de 80%."</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Estatísticas dos scores</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Estatísticas dos scores ---"</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">exposure_score_2d (PRINCIPAL):"</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(painel[<span class="st">'exposure_score_2d'</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">exposure_score_4d (ROBUSTEZ):"</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(painel[<span class="st">'exposure_score_4d'</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Correlação</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>mask_both <span class="op">=</span> painel[<span class="st">'exposure_score_2d'</span>].notna() <span class="op">&amp;</span> painel[<span class="st">'exposure_score_4d'</span>].notna()</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> mask_both.<span class="bu">any</span>():</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> painel.loc[mask_both, <span class="st">'exposure_score_2d'</span>].corr(</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        painel.loc[mask_both, <span class="st">'exposure_score_4d'</span>])</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Correlação 2d vs 4d ---"</span>)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Pearson: </span><span class="sc">{</span>corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span><span class="st">'Alta correlação — bom sinal de consistência.'</span> <span class="cf">if</span> corr <span class="op">&gt;</span> <span class="fl">0.8</span> <span class="cf">else</span> <span class="st">'Correlação moderada.'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Sanity check por grande grupo CBO</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'grande_grupo_cbo'</span>] <span class="op">=</span> painel[<span class="st">'cbo_4d'</span>].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Exposição por grande grupo CBO ---"</span>)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Grande Grupo'</span><span class="sc">:&lt;40}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Score 2d'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Score 4d'</span><span class="sc">:&gt;10}</span><span class="ss">"</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">62</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gg, nome <span class="kw">in</span> <span class="bu">sorted</span>(GRANDES_GRUPOS_CBO.items()):</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> painel[<span class="st">'grande_grupo_cbo'</span>] <span class="op">==</span> gg</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        s2d <span class="op">=</span> painel.loc[mask, <span class="st">'exposure_score_2d'</span>].mean()</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        s4d <span class="op">=</span> painel.loc[mask, <span class="st">'exposure_score_4d'</span>].mean()</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        s4d_str <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>s4d<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> <span class="kw">not</span> np.isnan(s4d) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>        flag <span class="op">=</span> <span class="st">" (!)"</span> <span class="cf">if</span> <span class="kw">not</span> np.isnan(s4d) <span class="kw">and</span> <span class="bu">abs</span>(s2d <span class="op">-</span> s4d) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>nome<span class="sc">:&lt;38}</span><span class="ss"> </span><span class="sc">{</span>s2d<span class="sc">:&gt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>s4d_str<span class="sc">:&gt;10}{</span>flag<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  (!) = diferença &gt; 0.1 entre 2d e 4d"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
CHECKPOINT — Crosswalk CBO → ISCO-08 (Dual)
============================================================

--- Cobertura ---
  2 dígitos (PRINCIPAL): 100.0%
  4 dígitos (ROBUSTEZ):  100.0%

--- Estatísticas dos scores ---

exposure_score_2d (PRINCIPAL):
count    32988.0000
mean         0.2778
std          0.1243
min          0.1167
25%          0.1658
50%          0.2459
75%          0.3725
max          0.6325
Name: exposure_score_2d, dtype: float64

exposure_score_4d (ROBUSTEZ):
count    32988.0000
mean         0.2830
std          0.1315
min          0.0900
25%          0.1658
50%          0.2500
75%          0.3650
max          0.7000
Name: exposure_score_4d, dtype: float64

--- Correlação 2d vs 4d ---
  Pearson: 0.9150
  Alta correlação — bom sinal de consistência.

--- Exposição por grande grupo CBO ---
Grande Grupo                               Score 2d   Score 4d
--------------------------------------------------------------
  Dirigentes                                  0.367      0.375
  Profissionais das ciências                  0.393      0.396
  Técnicos nível médio                        0.334      0.338
  Trabalhadores de serv. admin.               0.580      0.557
  Trabalhadores de serviços/comércio          0.243      0.247
  Agropecuária                                0.157      0.161
  Produção industrial                         0.161      0.165
  Operadores de máquinas                      0.213      0.217
  Manutenção e reparação                      0.143      0.187
  (!) = diferença &gt; 0.1 entre 2d e 4d</code></pre>
</div>
</div>
</section>
<section id="a.-definição-de-tratamento" class="level3" data-number="0.13">
<h3 data-number="0.13" class="anchored" data-anchor-id="a.-definição-de-tratamento"><span class="header-section-number">0.13</span> 5a. Definição de tratamento</h3>
<p>Definir as variáveis de tratamento para a análise DiD. O tratamento é baseado na <strong>exposição ocupacional à IA generativa</strong>: ocupações com alta exposição (top 20%) vs.&nbsp;baixa exposição.</p>
<section id="variáveis-criadas" class="level4" data-number="0.13.1">
<h4 data-number="0.13.1" class="anchored" data-anchor-id="variáveis-criadas"><span class="header-section-number">0.13.1</span> Variáveis criadas</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 38%">
<col style="width: 42%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>Variável</th>
<th>Definição</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>alta_exp</code></td>
<td>1 se <code>exposure_score_2d &gt;= percentil 80</code></td>
<td><strong>Especificação principal</strong></td>
</tr>
<tr class="even">
<td><code>alta_exp_10</code></td>
<td>1 se <code>exposure_score_2d &gt;= percentil 90</code></td>
<td>Robustez (cutoff)</td>
</tr>
<tr class="odd">
<td><code>alta_exp_25</code></td>
<td>1 se <code>exposure_score_2d &gt;= percentil 75</code></td>
<td>Robustez (cutoff)</td>
</tr>
<tr class="even">
<td><code>alta_exp_mediana</code></td>
<td>1 se <code>exposure_score_2d &gt;= mediana</code></td>
<td>Alternativa binária</td>
</tr>
<tr class="odd">
<td><code>quintil_exp</code></td>
<td>Quintil de exposição (Q1–Q5)</td>
<td>Análise por quantil</td>
</tr>
<tr class="even">
<td><code>alta_exp_4d</code></td>
<td>1 se <code>exposure_score_4d &gt;= percentil 80</code></td>
<td>Robustez (crosswalk 4d)</td>
</tr>
<tr class="odd">
<td><code>did</code></td>
<td><code>post × alta_exp</code></td>
<td>Interação DiD principal</td>
</tr>
<tr class="even">
<td><code>did_4d</code></td>
<td><code>post × alta_exp_4d</code></td>
<td>Interação DiD robustez</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><strong>Nota:</strong> Os thresholds são calculados sobre a distribuição de <strong>ocupações</strong> (uma obs por CBO), não ponderada por volume de movimentações. Cada ocupação tem peso igual na definição do tratamento.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Nota — Tratamento contínuo:</strong> Além das dummies, <code>exposure_score_2d</code> e <code>exposure_score_4d</code> podem ser usados diretamente como tratamento contínuo em especificações alternativas, conforme Hui et al.&nbsp;(2024).</p>
</blockquote>
<div id="8798f7cf" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.5a — Definição de tratamento</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Thresholds sobre a distribuição de ocupações (2d) ──</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>ocup_scores_2d <span class="op">=</span> painel.groupby(<span class="st">'cbo_4d'</span>)[<span class="st">'exposure_score_2d'</span>].first().dropna()</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>thresholds_2d <span class="op">=</span> {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp_10'</span>:      ocup_scores_2d.quantile(<span class="fl">0.90</span>),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp'</span>:         ocup_scores_2d.quantile(<span class="fl">0.80</span>),  <span class="co"># PRINCIPAL</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp_25'</span>:      ocup_scores_2d.quantile(<span class="fl">0.75</span>),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp_mediana'</span>:  ocup_scores_2d.quantile(<span class="fl">0.50</span>),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Thresholds de exposição (2d, PRINCIPAL):"</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, val <span class="kw">in</span> thresholds_2d.items():</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    n_above <span class="op">=</span> (ocup_scores_2d <span class="op">&gt;=</span> val).<span class="bu">sum</span>()</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> n_above <span class="op">/</span> <span class="bu">len</span>(ocup_scores_2d) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>n_above<span class="sc">}</span><span class="ss"> ocupações, </span><span class="sc">{</span>pct<span class="sc">:.0f}</span><span class="ss">%)"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Dummies de tratamento 2d ──</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, threshold <span class="kw">in</span> thresholds_2d.items():</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    painel[name] <span class="op">=</span> (painel[<span class="st">'exposure_score_2d'</span>] <span class="op">&gt;=</span> threshold).astype(<span class="bu">int</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Quintis</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'quintil_exp'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'exposure_score_2d'</span>].rank(method<span class="op">=</span><span class="st">'first'</span>),</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    q<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="st">'Q1 (Baixa)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5 (Alta)'</span>]</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Dummies 4d (ROBUSTEZ) ──</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>ocup_scores_4d <span class="op">=</span> painel.groupby(<span class="st">'cbo_4d'</span>)[<span class="st">'exposure_score_4d'</span>].first().dropna()</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>threshold_4d_80 <span class="op">=</span> ocup_scores_4d.quantile(<span class="fl">0.80</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'alta_exp_4d'</span>] <span class="op">=</span> (painel[<span class="st">'exposure_score_4d'</span>] <span class="op">&gt;=</span> threshold_4d_80).astype(<span class="bu">int</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Threshold 4d (p80): </span><span class="sc">{</span>threshold_4d_80<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>(ocup_scores_4d <span class="op">&gt;=</span> threshold_4d_80)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> ocupações)"</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Interações DiD ──</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'did'</span>] <span class="op">=</span> painel[<span class="st">'post'</span>] <span class="op">*</span> painel[<span class="st">'alta_exp'</span>]</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'did_4d'</span>] <span class="op">=</span> painel[<span class="st">'post'</span>] <span class="op">*</span> painel[<span class="st">'alta_exp_4d'</span>]</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Resumo ──</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Distribuição de tratamento ---"</span>)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Alta exp 2d (top 20%): </span><span class="sc">{</span>painel[<span class="st">'alta_exp'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> das obs"</span>)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Alta exp 4d (top 20%): </span><span class="sc">{</span>painel[<span class="st">'alta_exp_4d'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> das obs"</span>)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Períodos pré:  </span><span class="sc">{</span>painel[painel[<span class="st">'post'</span>]<span class="op">==</span><span class="dv">0</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Períodos pós:  </span><span class="sc">{</span>painel[painel[<span class="st">'post'</span>]<span class="op">==</span><span class="dv">1</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>concordancia <span class="op">=</span> (painel[<span class="st">'alta_exp'</span>] <span class="op">==</span> painel[<span class="st">'alta_exp_4d'</span>]).mean()</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Concordância 2d vs 4d: </span><span class="sc">{</span>concordancia<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabela de contingência</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> pd.crosstab(</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'post'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Pré'</span>, <span class="dv">1</span>: <span class="st">'Pós'</span>}),</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    painel[<span class="st">'alta_exp'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Controle'</span>, <span class="dv">1</span>: <span class="st">'Tratamento'</span>}),</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    margins<span class="op">=</span><span class="va">True</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Tabela de contingência (2d, principal):"</span>)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ct)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Thresholds de exposição (2d, PRINCIPAL):
  alta_exp_10: 0.4433 (78 ocupações, 12%)
  alta_exp: 0.3854 (131 ocupações, 21%)
  alta_exp_25: 0.3725 (165 ocupações, 26%)
  alta_exp_mediana: 0.2459 (332 ocupações, 53%)

Threshold 4d (p80): 0.3863 (137 ocupações)

--- Distribuição de tratamento ---
  Alta exp 2d (top 20%): 20.3% das obs
  Alta exp 4d (top 20%): 21.3% das obs
  Períodos pré:  14,058
  Períodos pós:  18,930
  Concordância 2d vs 4d: 93.1%

Tabela de contingência (2d, principal):
alta_exp  Controle  Tratamento    All
post                                 
Pré          11195        2863  14058
Pós          15092        3838  18930
All          26287        6701  32988</code></pre>
</div>
</div>
</section>
</section>
<section id="b.-verificar-tratamento-checkpoint" class="level3" data-number="0.14">
<h3 data-number="0.14" class="anchored" data-anchor-id="b.-verificar-tratamento-checkpoint"><span class="header-section-number">0.14</span> 5b. Verificar tratamento (CHECKPOINT)</h3>
<p>Validar a definição de tratamento: top/bottom ocupações por exposição, distribuição por quintil, e concordância entre especificações 2d e 4d.</p>
<div id="bc1457bd" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.5b — CHECKPOINT: Verificar definição de tratamento</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CHECKPOINT — Definição de Tratamento"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Top 10 ocupações mais expostas</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 10 ocupações MAIS expostas ---"</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>top10 <span class="op">=</span> painel.groupby(<span class="st">'cbo_4d'</span>).agg(</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    exposure<span class="op">=</span>(<span class="st">'exposure_score'</span>, <span class="st">'first'</span>),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    admissoes_total<span class="op">=</span>(<span class="st">'admissoes'</span>, <span class="st">'sum'</span>),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>).nlargest(<span class="dv">10</span>, <span class="st">'exposure'</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cbo, row <span class="kw">in</span> top10.iterrows():</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    nome <span class="op">=</span> GRANDES_GRUPOS_CBO.get(cbo[<span class="dv">0</span>], <span class="st">''</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CBO </span><span class="sc">{</span>cbo<span class="sc">}</span><span class="ss">: score=</span><span class="sc">{</span>row[<span class="st">'exposure'</span>]<span class="sc">:.3f}</span><span class="ss">, admissões=</span><span class="sc">{</span>row[<span class="st">'admissoes_total'</span>]<span class="sc">:,.0f}</span><span class="ss">  (</span><span class="sc">{</span>nome<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Bottom 10 ocupações menos expostas</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- 10 ocupações MENOS expostas ---"</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>bot10 <span class="op">=</span> painel.groupby(<span class="st">'cbo_4d'</span>).agg(</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    exposure<span class="op">=</span>(<span class="st">'exposure_score'</span>, <span class="st">'first'</span>),</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    admissoes_total<span class="op">=</span>(<span class="st">'admissoes'</span>, <span class="st">'sum'</span>),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>).nsmallest(<span class="dv">10</span>, <span class="st">'exposure'</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cbo, row <span class="kw">in</span> bot10.iterrows():</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    nome <span class="op">=</span> GRANDES_GRUPOS_CBO.get(cbo[<span class="dv">0</span>], <span class="st">''</span>)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CBO </span><span class="sc">{</span>cbo<span class="sc">}</span><span class="ss">: score=</span><span class="sc">{</span>row[<span class="st">'exposure'</span>]<span class="sc">:.3f}</span><span class="ss">, admissões=</span><span class="sc">{</span>row[<span class="st">'admissoes_total'</span>]<span class="sc">:,.0f}</span><span class="ss">  (</span><span class="sc">{</span>nome<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Distribuição por quintil</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Estatísticas por quintil de exposição ---"</span>)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> [<span class="st">'Q1 (Baixa)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5 (Alta)'</span>]:</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    sub <span class="op">=</span> painel[painel[<span class="st">'quintil_exp'</span>] <span class="op">==</span> q]</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(sub) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">: n=</span><span class="sc">{</span><span class="bu">len</span>(sub)<span class="sc">:,}</span><span class="ss">, "</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"exposure=</span><span class="sc">{</span>sub[<span class="st">'exposure_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, "</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"adm_mean=</span><span class="sc">{</span>sub[<span class="st">'admissoes'</span>]<span class="sc">.</span>mean()<span class="sc">:.0f}</span><span class="ss">, "</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"sal_medio=</span><span class="sc">{</span>sub[<span class="st">'salario_medio_adm'</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Concordância</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>concordancia <span class="op">=</span> (painel[<span class="st">'alta_exp'</span>] <span class="op">==</span> painel[<span class="st">'alta_exp_4d'</span>]).mean()</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Concordância 2d vs 4d: </span><span class="sc">{</span>concordancia<span class="sc">:.1%}</span><span class="ss"> ---"</span>)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CHECKPOINT CONCLUÍDO"</span>)</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
CHECKPOINT — Definição de Tratamento
============================================================

--- Top 10 ocupações MAIS expostas ---
  CBO 4101: score=0.632, admissões=343,660  (Trabalhadores de serv. admin.)
  CBO 4102: score=0.632, admissões=109,397  (Trabalhadores de serv. admin.)
  CBO 4110: score=0.632, admissões=7,169,112  (Trabalhadores de serv. admin.)
  CBO 4121: score=0.632, admissões=36,099  (Trabalhadores de serv. admin.)
  CBO 4122: score=0.632, admissões=217,727  (Trabalhadores de serv. admin.)
  CBO 4131: score=0.632, admissões=521,115  (Trabalhadores de serv. admin.)
  CBO 4132: score=0.632, admissões=178,605  (Trabalhadores de serv. admin.)
  CBO 4141: score=0.632, admissões=4,019,302  (Trabalhadores de serv. admin.)
  CBO 4142: score=0.632, admissões=406,552  (Trabalhadores de serv. admin.)
  CBO 4151: score=0.632, admissões=36,816  (Trabalhadores de serv. admin.)

--- 10 ocupações MENOS expostas ---
  CBO 9101: score=0.117, admissões=44,866  (Manutenção e reparação)
  CBO 9102: score=0.117, admissões=13,108  (Manutenção e reparação)
  CBO 9109: score=0.117, admissões=1,394  (Manutenção e reparação)
  CBO 9111: score=0.117, admissões=38,881  (Manutenção e reparação)
  CBO 9112: score=0.117, admissões=83,226  (Manutenção e reparação)
  CBO 9113: score=0.117, admissões=489,020  (Manutenção e reparação)
  CBO 9131: score=0.117, admissões=85,145  (Manutenção e reparação)
  CBO 9141: score=0.117, admissões=9,542  (Manutenção e reparação)
  CBO 9142: score=0.117, admissões=1,889  (Manutenção e reparação)
  CBO 9143: score=0.117, admissões=7,158  (Manutenção e reparação)

--- Estatísticas por quintil de exposição ---
  Q1 (Baixa): n=6,598, exposure=0.144, adm_mean=3200, sal_medio=4,469
  Q2: n=6,597, exposure=0.180, adm_mean=2207, sal_medio=2,599
  Q3: n=6,598, exposure=0.252, adm_mean=3676, sal_medio=7,018
  Q4: n=6,597, exposure=0.348, adm_mean=2735, sal_medio=8,072
  Q5 (Alta): n=6,598, exposure=0.466, adm_mean=3950, sal_medio=8,497

--- Concordância 2d vs 4d: 93.1% ---

============================================================
CHECKPOINT CONCLUÍDO
============================================================</code></pre>
</div>
</div>
</section>
<section id="a.-enriquecimento-do-painel-variáveis-adicionais" class="level3" data-number="0.15">
<h3 data-number="0.15" class="anchored" data-anchor-id="a.-enriquecimento-do-painel-variáveis-adicionais"><span class="header-section-number">0.15</span> 6a. Enriquecimento do painel (variáveis adicionais)</h3>
<p>Adicionar variáveis de controle e contexto temporal ao painel para a análise DiD.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 41%">
<col style="width: 37%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Variável</th>
<th>Cálculo</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>tempo_relativo_meses</code></td>
<td>Meses desde Dez/2022 (t=0)</td>
<td>Event study</td>
</tr>
<tr class="even">
<td><code>trend</code></td>
<td>Tendência linear (0, 1, 2, …)</td>
<td>Controle de tendência</td>
</tr>
<tr class="odd">
<td><code>mes_do_ano</code></td>
<td>Mês do ano (1-12)</td>
<td>Dummies de sazonalidade</td>
</tr>
<tr class="even">
<td><code>salario_sm</code></td>
<td><code>salario_medio_adm / SM do ano</code></td>
<td>Normalização salarial</td>
</tr>
<tr class="odd">
<td><code>grande_grupo_nome</code></td>
<td>Nome do grande grupo CBO</td>
<td>Efeitos fixos</td>
</tr>
</tbody>
</table>
<div id="2519c01b" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.6a — Enriquecimento do painel</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> periodo_num_to_months(pn):</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Converter periodo_num (YYYYMM) para contagem absoluta de meses."""</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (pn <span class="op">//</span> <span class="dv">100</span>) <span class="op">*</span> <span class="dv">12</span> <span class="op">+</span> (pn <span class="op">%</span> <span class="dv">100</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Tempo relativo ao tratamento ──</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>ref_periodo <span class="op">=</span> ANO_TRATAMENTO <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> MES_TRATAMENTO</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'meses_abs'</span>] <span class="op">=</span> painel[<span class="st">'periodo_num'</span>].<span class="bu">apply</span>(periodo_num_to_months)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>ref_meses <span class="op">=</span> periodo_num_to_months(ref_periodo)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'tempo_relativo_meses'</span>] <span class="op">=</span> painel[<span class="st">'meses_abs'</span>] <span class="op">-</span> ref_meses</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tempo relativo: [</span><span class="sc">{</span>painel[<span class="st">'tempo_relativo_meses'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>painel[<span class="st">'tempo_relativo_meses'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">] meses"</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Referência (t=0): </span><span class="sc">{</span>MES_TRATAMENTO<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>ANO_TRATAMENTO<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Tendência temporal e sazonalidade ──</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'trend'</span>] <span class="op">=</span> painel[<span class="st">'meses_abs'</span>] <span class="op">-</span> painel[<span class="st">'meses_abs'</span>].<span class="bu">min</span>()</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'mes_do_ano'</span>] <span class="op">=</span> painel[<span class="st">'mes'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Normalização salarial ──</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'sm_ano'</span>] <span class="op">=</span> painel[<span class="st">'ano'</span>].astype(<span class="bu">int</span>).<span class="bu">map</span>(SALARIO_MINIMO)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'salario_sm'</span>] <span class="op">=</span> painel[<span class="st">'salario_medio_adm'</span>] <span class="op">/</span> painel[<span class="st">'sm_ano'</span>]</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'ln_salario_sm'</span>] <span class="op">=</span> np.log(painel[<span class="st">'salario_sm'</span>].clip(lower<span class="op">=</span><span class="fl">0.1</span>))</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Salário real (deflacionado pelo IPCA, base Dez/2024 = 100) ──</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>painel <span class="op">=</span> painel.merge(df_ipca[[<span class="st">'ano'</span>, <span class="st">'mes'</span>, <span class="st">'indice'</span>]], on<span class="op">=</span>[<span class="st">'ano'</span>, <span class="st">'mes'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'salario_real_adm'</span>] <span class="op">=</span> painel[<span class="st">'salario_medio_adm'</span>] <span class="op">*</span> (INDICE_BASE <span class="op">/</span> painel[<span class="st">'indice'</span>])</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'ln_salario_real_adm'</span>] <span class="op">=</span> np.log(painel[<span class="st">'salario_real_adm'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Grande grupo ocupacional ──</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'grande_grupo_cbo'</span>] <span class="op">=</span> painel[<span class="st">'cbo_4d'</span>].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">'grande_grupo_nome'</span>] <span class="op">=</span> painel[<span class="st">'grande_grupo_cbo'</span>].<span class="bu">map</span>(GRANDES_GRUPOS_CBO)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Variáveis adicionadas: tempo_relativo_meses, trend, mes_do_ano, "</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"salario_sm, ln_salario_sm, salario_real_adm, ln_salario_real_adm, grande_grupo_nome"</span>)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Colunas totais: </span><span class="sc">{</span>painel<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tempo relativo: [-23, 30] meses
Referência (t=0): 12/2022

Variáveis adicionadas: tempo_relativo_meses, trend, mes_do_ano, salario_sm, ln_salario_sm, salario_real_adm, ln_salario_real_adm, grande_grupo_nome
Colunas totais: 74</code></pre>
</div>
</div>
</section>
<section id="anexo-1-integração-anthropic-automation-vs-augmentation" class="level3" data-number="0.16">
<h3 data-number="0.16" class="anchored" data-anchor-id="anexo-1-integração-anthropic-automation-vs-augmentation"><span class="header-section-number">0.16</span> Anexo 1: Integração Anthropic (Automation vs Augmentation)</h3>
<p>Integração do <strong>Anthropic Economic Index</strong> (Brynjolfsson et al., 2025 — “Canaries in the Coal Mine”) para diferenciar ocupações onde a IA atua como <strong>Automação</strong> (substitui trabalho) vs <strong>Augmentação</strong> (complementa). O índice é construído a partir dos modos de colaboração (directive, feedback loop = automação; learning, task iteration, validation = augmentação) e mapeado para CBO 4d via SOC → ISCO-08 → COD, com imputação hierárquica para cobertura total.</p>
<p><strong>Arquivos necessários em <code>data/input</code> (copiar das pastas do repositório se não existirem):</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 72%">
</colgroup>
<thead>
<tr class="header">
<th>Arquivo</th>
<th>Origem no repositório</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>aei_raw_claude_ai_2025-11-13_to_2025-11-20.csv</code></td>
<td><code>EconomicIndex/release_2026_01_15/data/intermediate/</code> ou <code>etapa2_anthropic_index/</code></td>
</tr>
<tr class="even">
<td><code>onet_task_statements.csv</code></td>
<td><code>EconomicIndex/release_2025_09_15/data/intermediate/</code></td>
</tr>
<tr class="odd">
<td><code>Crosswalk SOC 2010 a 2018.xlsx</code></td>
<td><code>etapa3_crosswalk_onet_isco08/data_input/</code></td>
</tr>
<tr class="even">
<td><code>Crosswalk SOC 2010 ISCO-08.xls</code></td>
<td><code>etapa3_crosswalk_onet_isco08/data_input/</code></td>
</tr>
<tr class="odd">
<td><code>Estrutura Ocupação COD.xls</code></td>
<td><code>etapa1_ia_generativa/data/raw/</code> ou <code>etapa3_crosswalk_onet_isco08/data_input/</code></td>
</tr>
</tbody>
</table>
<p>Se <code>anthropic_automation_augmentation_cbo.parquet</code> existir em <code>data/processed</code> e <code>KEEP_ANTHROPIC_INDEX = True</code>, o processamento pesado é pulado e o cache é carregado.</p>
<div id="470b1b6a" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Anexo 1 — Copiar inputs para data/input (se ainda não estiverem) para notebook autocontido</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Raiz do projeto: se estamos em notebook/, sobe um nível</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>_cwd <span class="op">=</span> Path(<span class="st">"."</span>).resolve()</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>REPO_ROOT <span class="op">=</span> _cwd.parent <span class="cf">if</span> (_cwd <span class="op">/</span> <span class="st">"etapa3_crosswalk_onet_isco08"</span>).exists() <span class="op">==</span> <span class="va">False</span> <span class="cf">else</span> _cwd</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>origins <span class="op">=</span> [</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    (REPO_ROOT <span class="op">/</span> <span class="st">"EconomicIndex"</span> <span class="op">/</span> <span class="st">"release_2026_01_15"</span> <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"intermediate"</span> <span class="op">/</span> <span class="st">"aei_raw_claude_ai_2025-11-13_to_2025-11-20.csv"</span>, DATA_INPUT <span class="op">/</span> <span class="st">"aei_raw_claude_ai_2025-11-13_to_2025-11-20.csv"</span>),</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    (REPO_ROOT <span class="op">/</span> <span class="st">"EconomicIndex"</span> <span class="op">/</span> <span class="st">"release_2025_09_15"</span> <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"intermediate"</span> <span class="op">/</span> <span class="st">"onet_task_statements.csv"</span>, DATA_INPUT <span class="op">/</span> <span class="st">"onet_task_statements.csv"</span>),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    (REPO_ROOT <span class="op">/</span> <span class="st">"etapa3_crosswalk_onet_isco08"</span> <span class="op">/</span> <span class="st">"data_input"</span> <span class="op">/</span> <span class="st">"Crosswalk SOC 2010 a 2018.xlsx"</span>, DATA_INPUT <span class="op">/</span> <span class="st">"Crosswalk SOC 2010 a 2018.xlsx"</span>),</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    (REPO_ROOT <span class="op">/</span> <span class="st">"etapa3_crosswalk_onet_isco08"</span> <span class="op">/</span> <span class="st">"data_input"</span> <span class="op">/</span> <span class="st">"Crosswalk SOC 2010 ISCO-08.xls"</span>, DATA_INPUT <span class="op">/</span> <span class="st">"Crosswalk SOC 2010 ISCO-08.xls"</span>),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    (REPO_ROOT <span class="op">/</span> <span class="st">"etapa1_ia_generativa"</span> <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"raw"</span> <span class="op">/</span> <span class="st">"Estrutura Ocupação COD.xls"</span>, DATA_INPUT <span class="op">/</span> <span class="st">"Estrutura Ocupação COD.xls"</span>),</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> src, dst <span class="kw">in</span> origins:</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> src.exists() <span class="kw">and</span> (<span class="kw">not</span> dst.exists() <span class="kw">or</span> dst.stat().st_size <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        shutil.copy2(src, dst)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Copiado: </span><span class="sc">{</span>dst<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> src.exists() <span class="kw">and</span> dst.exists():</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Já em data/input: </span><span class="sc">{</span>dst<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> src.exists():</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"AVISO: não encontrado no repo: </span><span class="sc">{</span>src<span class="sc">.</span>relative_to(REPO_ROOT) <span class="cf">if</span> src<span class="sc">.</span>is_relative_to(REPO_ROOT) <span class="cf">else</span> src<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Inputs em data/input conferidos."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Copiado: aei_raw_claude_ai_2025-11-13_to_2025-11-20.csv
Copiado: onet_task_statements.csv
Copiado: Crosswalk SOC 2010 a 2018.xlsx
Copiado: Crosswalk SOC 2010 ISCO-08.xls
Inputs em data/input conferidos.</code></pre>
</div>
</div>
<div id="ca697ae7" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Anexo 1 — Carregar cache ou rodar pipeline Anthropic (Automation vs Augmentation)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _weighted_mean(values, weights):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> <span class="op">~</span>(pd.isna(values) <span class="op">|</span> pd.isna(weights))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span>: <span class="cf">return</span> np.nan</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    v, w <span class="op">=</span> values[mask], weights[mask]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.average(v, weights<span class="op">=</span>w) <span class="cf">if</span> w.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> v.mean()</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _calculate_indices(df_task):</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    required_modes <span class="op">=</span> [<span class="st">"directive"</span>, <span class="st">"feedback loop"</span>, <span class="st">"learning"</span>, <span class="st">"task iteration"</span>, <span class="st">"validation"</span>]</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> required_modes:</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> m <span class="kw">not</span> <span class="kw">in</span> df_task.columns: df_task[m] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    df_task[<span class="st">"total_collab"</span>] <span class="op">=</span> df_task[required_modes].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> df_task[<span class="st">"total_collab"</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    df_task.loc[mask, <span class="st">"automation_share"</span>] <span class="op">=</span> (df_task.loc[mask, <span class="st">"directive"</span>] <span class="op">+</span> df_task.loc[mask, <span class="st">"feedback loop"</span>]) <span class="op">/</span> df_task.loc[mask, <span class="st">"total_collab"</span>]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    df_task.loc[mask, <span class="st">"augmentation_share"</span>] <span class="op">=</span> (df_task.loc[mask, <span class="st">"learning"</span>] <span class="op">+</span> df_task.loc[mask, <span class="st">"task iteration"</span>] <span class="op">+</span> df_task.loc[mask, <span class="st">"validation"</span>]) <span class="op">/</span> df_task.loc[mask, <span class="st">"total_collab"</span>]</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    df_task[<span class="st">"automation_share"</span>] <span class="op">=</span> df_task[<span class="st">"automation_share"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    df_task[<span class="st">"augmentation_share"</span>] <span class="op">=</span> df_task[<span class="st">"augmentation_share"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    df_task[<span class="st">"automation_index"</span>] <span class="op">=</span> df_task[<span class="st">"automation_share"</span>] <span class="op">-</span> df_task[<span class="st">"augmentation_share"</span>]</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    df_task[<span class="st">"dominant_mode"</span>] <span class="op">=</span> np.where(df_task[<span class="st">"automation_index"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"automation"</span>, <span class="st">"augmentation"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_task</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>df_anthropic_cbo <span class="op">=</span> <span class="va">None</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEEP_ANTHROPIC_INDEX <span class="kw">and</span> ANTHROPIC_INDEX_CACHE.exists():</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    df_anthropic_cbo <span class="op">=</span> pd.read_parquet(ANTHROPIC_INDEX_CACHE)</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Índice Anthropic carregado do cache: </span><span class="sc">{</span>ANTHROPIC_INDEX_CACHE<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(df_anthropic_cbo)<span class="sc">}</span><span class="ss"> ocupações CBO 4d)"</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pipeline completo</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    AEI_RAW <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"aei_raw_claude_ai_2025-11-13_to_2025-11-20.csv"</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    ONET_TASKS <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"onet_task_statements.csv"</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    CROSSWALK_10_18 <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"Crosswalk SOC 2010 a 2018.xlsx"</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    CROSSWALK_ISCO <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"Crosswalk SOC 2010 ISCO-08.xls"</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    ESTRUTURA_COD <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"Estrutura Ocupação COD.xls"</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> AEI_RAW.exists() <span class="kw">or</span> <span class="kw">not</span> ONET_TASKS.exists():</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="st">"Coloque aei_raw_claude_ai_*.csv e onet_task_statements.csv em data/input. Veja Anexo 1."</span>)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) Carregar Anthropic + O*NET</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    df_raw <span class="op">=</span> pd.read_csv(AEI_RAW)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (df_raw[<span class="st">"facet"</span>] <span class="op">==</span> <span class="st">"onet_task::collaboration"</span>) <span class="op">&amp;</span> (df_raw[<span class="st">"geo_id"</span>] <span class="op">==</span> <span class="st">"GLOBAL"</span>)</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    df_collab <span class="op">=</span> df_raw[mask].copy()</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    df_collab[[<span class="st">"task_desc"</span>, <span class="st">"mode"</span>]] <span class="op">=</span> df_collab[<span class="st">"cluster_name"</span>].<span class="bu">str</span>.rsplit(<span class="st">"::"</span>, n<span class="op">=</span><span class="dv">1</span>, expand<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    df_collab[<span class="st">"task_desc_clean"</span>] <span class="op">=</span> df_collab[<span class="st">"task_desc"</span>].<span class="bu">str</span>.strip().<span class="bu">str</span>.lower().<span class="bu">str</span>.rstrip(<span class="st">"."</span>)</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    df_pivot <span class="op">=</span> df_collab.pivot_table(index<span class="op">=</span><span class="st">"task_desc_clean"</span>, columns<span class="op">=</span><span class="st">"mode"</span>, values<span class="op">=</span><span class="st">"value"</span>, aggfunc<span class="op">=</span><span class="st">"first"</span>).reset_index()</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>    df_onet <span class="op">=</span> pd.read_csv(ONET_TASKS)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    df_onet[<span class="st">"task_desc_clean"</span>] <span class="op">=</span> df_onet[<span class="st">"Task"</span>].<span class="bu">str</span>.strip().<span class="bu">str</span>.lower().<span class="bu">str</span>.rstrip(<span class="st">"."</span>)</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>    task_mapping <span class="op">=</span> df_onet[[<span class="st">"task_desc_clean"</span>, <span class="st">"O*NET-SOC Code"</span>]].drop_duplicates()</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    task_mapping.columns <span class="op">=</span> [<span class="st">"task_desc_clean"</span>, <span class="st">"onet_soc_code"</span>]</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    df_pivot <span class="op">=</span> df_pivot.merge(task_mapping, on<span class="op">=</span><span class="st">"task_desc_clean"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    mask_count <span class="op">=</span> (df_raw[<span class="st">"facet"</span>] <span class="op">==</span> <span class="st">"onet_task"</span>) <span class="op">&amp;</span> (df_raw[<span class="st">"variable"</span>] <span class="op">==</span> <span class="st">"onet_task_count"</span>) <span class="op">&amp;</span> (df_raw[<span class="st">"geo_id"</span>] <span class="op">==</span> <span class="st">"GLOBAL"</span>)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    df_counts <span class="op">=</span> df_raw[mask_count][[<span class="st">"cluster_name"</span>, <span class="st">"value"</span>]].rename(columns<span class="op">=</span>{<span class="st">"cluster_name"</span>: <span class="st">"task_desc"</span>, <span class="st">"value"</span>: <span class="st">"usage_volume"</span>})</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    df_counts[<span class="st">"task_desc_clean"</span>] <span class="op">=</span> df_counts[<span class="st">"task_desc"</span>].<span class="bu">str</span>.strip().<span class="bu">str</span>.lower().<span class="bu">str</span>.rstrip(<span class="st">"."</span>)</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    df_counts <span class="op">=</span> df_counts.groupby(<span class="st">"task_desc_clean"</span>)[<span class="st">"usage_volume"</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    df_task <span class="op">=</span> df_pivot.merge(df_counts, on<span class="op">=</span><span class="st">"task_desc_clean"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    df_task <span class="op">=</span> _calculate_indices(df_task)</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    df_onet[<span class="st">"soc_6d"</span>] <span class="op">=</span> df_onet[<span class="st">"O*NET-SOC Code"</span>].<span class="bu">str</span>.split(<span class="st">"."</span>).<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    soc_mapping <span class="op">=</span> df_onet[[<span class="st">"O*NET-SOC Code"</span>, <span class="st">"soc_6d"</span>, <span class="st">"Title"</span>]].drop_duplicates()</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    soc_mapping.columns <span class="op">=</span> [<span class="st">"onet_soc_code"</span>, <span class="st">"soc_6d"</span>, <span class="st">"occupation_title"</span>]</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    df_merged <span class="op">=</span> df_task.merge(soc_mapping, on<span class="op">=</span><span class="st">"onet_soc_code"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> agg_wm(x): <span class="cf">return</span> _weighted_mean(x, df_merged.loc[x.index, <span class="st">"usage_volume"</span>])</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    df_soc <span class="op">=</span> df_merged.groupby([<span class="st">"soc_6d"</span>, <span class="st">"occupation_title"</span>]).agg(</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>        automation_share<span class="op">=</span>(<span class="st">"automation_share"</span>, agg_wm), augmentation_share<span class="op">=</span>(<span class="st">"augmentation_share"</span>, agg_wm), usage_volume<span class="op">=</span>(<span class="st">"usage_volume"</span>, <span class="st">"sum"</span>)</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>    df_soc[<span class="st">"automation_index_cai"</span>] <span class="op">=</span> df_soc[<span class="st">"automation_share"</span>] <span class="op">-</span> df_soc[<span class="st">"augmentation_share"</span>]</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    df_soc[<span class="st">"automation_share_cai"</span>] <span class="op">=</span> df_soc[<span class="st">"automation_share"</span>]</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    df_soc[<span class="st">"augmentation_share_cai"</span>] <span class="op">=</span> df_soc[<span class="st">"augmentation_share"</span>]</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    df_soc.to_csv(DATA_PROCESSED <span class="op">/</span> <span class="st">"onet_automation_augmentation_index.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Crosswalk SOC -&gt; ISCO-08 (fallback SOC 2018 -&gt; 2010 -&gt; ISCO)</span></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>    df_10_18 <span class="op">=</span> pd.read_excel(CROSSWALK_10_18, skiprows<span class="op">=</span><span class="dv">7</span>).iloc[:, :<span class="dv">4</span>]</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>    df_10_18.columns <span class="op">=</span> [<span class="st">"soc_2010_code"</span>, <span class="st">"soc_2010_title"</span>, <span class="st">"soc_2018_code"</span>, <span class="st">"soc_2018_title"</span>]</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>    df_10_18[<span class="st">"soc_2018_code"</span>] <span class="op">=</span> df_10_18[<span class="st">"soc_2018_code"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">".00"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">False</span>).<span class="bu">str</span>.strip()</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>    df_10_18 <span class="op">=</span> df_10_18.dropna(subset<span class="op">=</span>[<span class="st">"soc_2010_code"</span>, <span class="st">"soc_2018_code"</span>])</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>    df_soc_isco <span class="op">=</span> pd.read_excel(CROSSWALK_ISCO, sheet_name<span class="op">=</span><span class="st">"2010 SOC to ISCO-08"</span>, skiprows<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>    df_soc_isco.columns <span class="op">=</span> [<span class="st">"soc_2010_code"</span>, <span class="st">"soc_2010_title"</span>, <span class="st">"part"</span>, <span class="st">"isco_08_code"</span>, <span class="st">"isco_08_title"</span>, <span class="st">"comment"</span>]</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>    df_soc_isco <span class="op">=</span> df_soc_isco.dropna(subset<span class="op">=</span>[<span class="st">"soc_2010_code"</span>, <span class="st">"isco_08_code"</span>])</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>    df_soc_isco[<span class="st">"isco_08_code"</span>] <span class="op">=</span> df_soc_isco[<span class="st">"isco_08_code"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">".0"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">False</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>    df_merged <span class="op">=</span> df_soc.merge(df_10_18, left_on<span class="op">=</span><span class="st">"soc_6d"</span>, right_on<span class="op">=</span><span class="st">"soc_2018_code"</span>, how<span class="op">=</span><span class="st">"inner"</span>).merge(df_soc_isco, on<span class="op">=</span><span class="st">"soc_2010_code"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> agg_isco(x): <span class="cf">return</span> _weighted_mean(x, df_merged.loc[x.index, <span class="st">"usage_volume"</span>])</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>    df_isco <span class="op">=</span> df_merged.groupby(<span class="st">"isco_08_code"</span>).agg(</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>        automation_share_cai<span class="op">=</span>(<span class="st">"automation_share_cai"</span>, agg_isco), augmentation_share_cai<span class="op">=</span>(<span class="st">"augmentation_share_cai"</span>, agg_isco),</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>        automation_index_cai<span class="op">=</span>(<span class="st">"automation_index_cai"</span>, agg_isco), usage_volume<span class="op">=</span>(<span class="st">"usage_volume"</span>, <span class="st">"sum"</span>)</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>    df_isco[<span class="st">"dominant_mode_cai"</span>] <span class="op">=</span> np.where(df_isco[<span class="st">"automation_index_cai"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"automation"</span>, <span class="st">"augmentation"</span>)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>    df_isco.to_csv(DATA_PROCESSED <span class="op">/</span> <span class="st">"isco_automation_augmentation_index.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="61b60bc4" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Anexo 1 — Continuação: ISCO -&gt; COD, imputação hierárquica, salvar cache (só roda se pipeline foi executado)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> df_anthropic_cbo <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        df_esco <span class="op">=</span> pd.read_csv(DATA_PROCESSED <span class="op">/</span> <span class="st">"isco_automation_augmentation_index.csv"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"Execute a célula anterior do Anexo 1 primeiro."</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    ESTRUTURA_COD <span class="op">=</span> DATA_INPUT <span class="op">/</span> <span class="st">"Estrutura Ocupação COD.xls"</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ESTRUTURA_COD.exists():</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="st">"Coloque Estrutura Ocupação COD.xls em data/input."</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        df_cod <span class="op">=</span> pd.read_excel(ESTRUTURA_COD, sheet_name<span class="op">=</span><span class="st">"Estrutura COD"</span>, engine<span class="op">=</span><span class="st">"xlrd"</span>, header<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        df_cod <span class="op">=</span> pd.read_excel(ESTRUTURA_COD, sheet_name<span class="op">=</span><span class="st">"Estrutura COD"</span>, engine<span class="op">=</span><span class="st">"openpyxl"</span>, header<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    df_cod.columns <span class="op">=</span> [<span class="st">"grande_grupo"</span>, <span class="st">"subgrupo_principal"</span>, <span class="st">"subgrupo"</span>, <span class="st">"grupo_base"</span>, <span class="st">"denominacao"</span>]</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    df_gb <span class="op">=</span> df_cod.dropna(subset<span class="op">=</span>[<span class="st">"grupo_base"</span>])[[<span class="st">"grupo_base"</span>, <span class="st">"denominacao"</span>]].copy()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    df_gb[<span class="st">"cod_cod"</span>] <span class="op">=</span> df_gb[<span class="st">"grupo_base"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">".0"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">False</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    df_esco[<span class="st">"isco_08_code"</span>] <span class="op">=</span> df_esco[<span class="st">"isco_08_code"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    df_cod_merge <span class="op">=</span> df_gb[[<span class="st">"cod_cod"</span>, <span class="st">"denominacao"</span>]].merge(df_esco, left_on<span class="op">=</span><span class="st">"cod_cod"</span>, right_on<span class="op">=</span><span class="st">"isco_08_code"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    metrics_cols <span class="op">=</span> [<span class="st">"automation_share_cai"</span>, <span class="st">"augmentation_share_cai"</span>, <span class="st">"automation_index_cai"</span>]</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    df_cod_merge[<span class="st">"imputation_method"</span>] <span class="op">=</span> np.where(df_cod_merge[<span class="st">"automation_index_cai"</span>].notna(), <span class="st">"direct_match"</span>, <span class="st">"missing"</span>)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    df_isco <span class="op">=</span> df_esco.copy()</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    df_isco[<span class="st">"isco_3d"</span>] <span class="op">=</span> df_isco[<span class="st">"isco_08_code"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>[:<span class="dv">3</span>]</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    df_isco[<span class="st">"isco_2d"</span>] <span class="op">=</span> df_isco[<span class="st">"isco_08_code"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>[:<span class="dv">2</span>]</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"usage_volume"</span> <span class="kw">not</span> <span class="kw">in</span> df_isco.columns: df_isco[<span class="st">"usage_volume"</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    avg_3d <span class="op">=</span> df_isco.groupby(<span class="st">"isco_3d"</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> g: pd.Series({c: _weighted_mean(g[c], g[<span class="st">"usage_volume"</span>]) <span class="cf">for</span> c <span class="kw">in</span> metrics_cols <span class="cf">if</span> c <span class="kw">in</span> g.columns})).reset_index()</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    avg_2d <span class="op">=</span> df_isco.groupby(<span class="st">"isco_2d"</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> g: pd.Series({c: _weighted_mean(g[c], g[<span class="st">"usage_volume"</span>]) <span class="cf">for</span> c <span class="kw">in</span> metrics_cols <span class="cf">if</span> c <span class="kw">in</span> g.columns})).reset_index()</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    df_cod_merge[<span class="st">"cod_3d"</span>] <span class="op">=</span> df_cod_merge[<span class="st">"cod_cod"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>[:<span class="dv">3</span>]</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    df_cod_merge[<span class="st">"cod_2d"</span>] <span class="op">=</span> df_cod_merge[<span class="st">"cod_cod"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>[:<span class="dv">2</span>]</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    mask_miss <span class="op">=</span> df_cod_merge[<span class="st">"automation_index_cai"</span>].isna()</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> df_cod_merge[mask_miss].index:</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>        c3 <span class="op">=</span> df_cod_merge.loc[idx, <span class="st">"cod_3d"</span>]</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>        row3 <span class="op">=</span> avg_3d[avg_3d[<span class="st">"isco_3d"</span>] <span class="op">==</span> c3]</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(row3) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> metrics_cols:</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> c <span class="kw">in</span> row3.columns: df_cod_merge.loc[idx, c] <span class="op">=</span> row3[c].iloc[<span class="dv">0</span>]</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>            df_cod_merge.loc[idx, <span class="st">"imputation_method"</span>] <span class="op">=</span> <span class="st">"hierarchical_3d_mean"</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    mask_miss <span class="op">=</span> df_cod_merge[<span class="st">"automation_index_cai"</span>].isna()</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> df_cod_merge[mask_miss].index:</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>        c2 <span class="op">=</span> df_cod_merge.loc[idx, <span class="st">"cod_2d"</span>]</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>        row2 <span class="op">=</span> avg_2d[avg_2d[<span class="st">"isco_2d"</span>] <span class="op">==</span> c2]</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(row2) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> metrics_cols:</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> c <span class="kw">in</span> row2.columns: df_cod_merge.loc[idx, c] <span class="op">=</span> row2[c].iloc[<span class="dv">0</span>]</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>            df_cod_merge.loc[idx, <span class="st">"imputation_method"</span>] <span class="op">=</span> <span class="st">"hierarchical_2d_mean"</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    mask_still <span class="op">=</span> df_cod_merge[<span class="st">"automation_index_cai"</span>].isna()</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    df_cod_merge.loc[mask_still, metrics_cols] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    df_cod_merge.loc[mask_still, <span class="st">"imputation_method"</span>] <span class="op">=</span> <span class="st">"zero_imputation_no_data"</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    df_cod_merge[<span class="st">"dominant_mode_cai"</span>] <span class="op">=</span> np.where(df_cod_merge[<span class="st">"automation_index_cai"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"automation"</span>, <span class="st">"augmentation"</span>)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    df_cod_merge.to_csv(DATA_PROCESSED <span class="op">/</span> <span class="st">"cod_automation_augmentation_index_final.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    df_anthropic_cbo <span class="op">=</span> df_cod_merge[[<span class="st">"cod_cod"</span>, <span class="st">"automation_share_cai"</span>, <span class="st">"augmentation_share_cai"</span>, <span class="st">"automation_index_cai"</span>, <span class="st">"dominant_mode_cai"</span>, <span class="st">"imputation_method"</span>]].copy()</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    df_anthropic_cbo <span class="op">=</span> df_anthropic_cbo.rename(columns<span class="op">=</span>{<span class="st">"cod_cod"</span>: <span class="st">"cbo_4d"</span>, <span class="st">"automation_index_cai"</span>: <span class="st">"anthropic_automation_index"</span>})</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    df_anthropic_cbo[<span class="st">"cbo_4d"</span>] <span class="op">=</span> df_anthropic_cbo[<span class="st">"cbo_4d"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    df_anthropic_cbo.to_parquet(ANTHROPIC_INDEX_CACHE, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Pipeline Anthropic concluído. Cache salvo: </span><span class="sc">{</span>ANTHROPIC_INDEX_CACHE<span class="sc">}</span><span class="ss">. Ocupações: </span><span class="sc">{</span><span class="bu">len</span>(df_anthropic_cbo)<span class="sc">}</span><span class="ss">."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pipeline Anthropic concluído. Cache salvo: data/processed/anthropic_automation_augmentation_cbo.parquet. Ocupações: 435.</code></pre>
</div>
</div>
<div id="023ac036" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Anexo 1 — Merge do índice Anthropic ao painel e criação das dummies (automation vs augmentation)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Garantir formato cbo_4d string 4 dígitos para o merge</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>_cbo <span class="op">=</span> painel[<span class="st">"cbo_4d"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>df_anthropic_cbo[<span class="st">"cbo_4d"</span>] <span class="op">=</span> df_anthropic_cbo[<span class="st">"cbo_4d"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">4</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>cols_merge <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"anthropic_automation_index"</span>, <span class="st">"automation_share_cai"</span>, <span class="st">"augmentation_share_cai"</span>, <span class="st">"dominant_mode_cai"</span>] <span class="cf">if</span> c <span class="kw">in</span> df_anthropic_cbo.columns]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>idx_cbo <span class="op">=</span> df_anthropic_cbo.set_index(<span class="st">"cbo_4d"</span>)[cols_merge]</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>painel <span class="op">=</span> painel.copy()</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_merge:</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    painel[c] <span class="op">=</span> _cbo.<span class="bu">map</span>(idx_cbo[c] <span class="cf">if</span> c <span class="kw">in</span> idx_cbo.columns <span class="cf">else</span> idx_cbo.squeeze()).values</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Score contínuo: preencher NaN com 0 (imputação hierárquica já cobriu todas as CBOs no índice)</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">"anthropic_automation_index"</span>] <span class="op">=</span> painel[<span class="st">"anthropic_automation_index"</span>].fillna(<span class="fl">0.0</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dummies: Automação = 1 quando automation &gt; augmentation (índice &gt; 0); Augmentação = 1 quando augmentation &gt; automation</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">"is_automation"</span>] <span class="op">=</span> (painel[<span class="st">"anthropic_automation_index"</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>painel[<span class="st">"is_augmentation"</span>] <span class="op">=</span> (painel[<span class="st">"anthropic_automation_index"</span>] <span class="op">&lt;=</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Anexo 1 — Merge concluído. anthropic_automation_index: cobertura </span><span class="sc">{</span>painel[<span class="st">'anthropic_automation_index'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">. "</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"is_automation=</span><span class="sc">{</span>painel[<span class="st">'is_automation'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">, is_augmentation=</span><span class="sc">{</span>painel[<span class="st">'is_augmentation'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anexo 1 — Merge concluído. anthropic_automation_index: cobertura 100.0%. is_automation=5.4%, is_augmentation=94.6%</code></pre>
</div>
</div>
</section>
<section id="salvar-dataset-analítico-final" class="level3" data-number="0.17">
<h3 data-number="0.17" class="anchored" data-anchor-id="salvar-dataset-analítico-final"><span class="header-section-number">0.17</span> 7. Salvar dataset analítico final</h3>
<p>Selecionar colunas finais, remover ocupações sem score de exposição e salvar o dataset pronto para a análise DiD (Notebook 2b).</p>
<p><strong>Saída:</strong> - <code>data/output/painel_caged_did_ready.parquet</code> — formato eficiente para análise - <code>data/output/painel_caged_did_ready.csv</code> — backup legível</p>
<div id="f56e1220" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Etapa 2a.7 — Salvar dataset analítico final</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> KEEP_PANEL_FINAL:</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> PAINEL_FINAL_PARQUET.exists():</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        PAINEL_FINAL_PARQUET.unlink()</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Cache removido: </span><span class="sc">{</span>PAINEL_FINAL_PARQUET<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> PAINEL_FINAL_CSV.exists():</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        PAINEL_FINAL_CSV.unlink()</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Cache removido: </span><span class="sc">{</span>PAINEL_FINAL_CSV<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Selecionar colunas finais ──</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>cols_finais <span class="op">=</span> [</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identificação</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cbo_4d'</span>, <span class="st">'cbo_2d'</span>, <span class="st">'ano'</span>, <span class="st">'mes'</span>, <span class="st">'periodo'</span>, <span class="st">'periodo_num'</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcomes</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'admissoes'</span>, <span class="st">'desligamentos'</span>, <span class="st">'saldo'</span>, <span class="st">'n_movimentacoes'</span>,</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ln_admissoes'</span>, <span class="st">'ln_desligamentos'</span>,</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'salario_medio_adm'</span>, <span class="st">'salario_mediano_adm'</span>, <span class="st">'salario_medio_desl'</span>,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ln_salario_adm'</span>, <span class="st">'salario_sm'</span>, <span class="st">'ln_salario_sm'</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'salario_real_adm'</span>, <span class="st">'ln_salario_real_adm'</span>,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demografia das admissões (proporções)</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'idade_media_adm'</span>, <span class="st">'pct_mulher_adm'</span>, <span class="st">'pct_superior_adm'</span>, <span class="st">'pct_branco_adm'</span>, <span class="st">'pct_negro_adm'</span>, <span class="st">'pct_jovem_adm'</span>,</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pct_tecnologico_adm'</span>, <span class="st">'setor_tecnologico'</span>,</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Heterogeneidade: salários (log)</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ln_salario_homem'</span>, <span class="st">'ln_salario_mulher'</span>, <span class="st">'ln_salario_jovem'</span>, <span class="st">'ln_salario_naojovem'</span>,</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ln_salario_branco'</span>, <span class="st">'ln_salario_negro'</span>, <span class="st">'ln_salario_superior'</span>, <span class="st">'ln_salario_medio'</span>,</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Heterogeneidade: volumes (log)</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ln_admissoes_homem'</span>, <span class="st">'ln_admissoes_mulher'</span>, <span class="st">'ln_admissoes_jovem'</span>, <span class="st">'ln_admissoes_negro'</span>,</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exposição IA — DUAL</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exposure_score_2d'</span>,   <span class="co"># PRINCIPAL</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exposure_score_4d'</span>,   <span class="co"># ROBUSTEZ</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tratamento — DUAL</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp'</span>,            <span class="co"># Top 20% score 2d (PRINCIPAL)</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp_10'</span>, <span class="st">'alta_exp_25'</span>, <span class="st">'alta_exp_mediana'</span>, <span class="st">'quintil_exp'</span>,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alta_exp_4d'</span>,         <span class="co"># Top 20% score 4d (ROBUSTEZ)</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'post'</span>, <span class="st">'did'</span>, <span class="st">'did_4d'</span>, <span class="st">'tempo_relativo_meses'</span>, <span class="st">'trend'</span>, <span class="st">'mes_do_ano'</span>,</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Classificação</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grande_grupo_cbo'</span>, <span class="st">'grande_grupo_nome'</span>,</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Anthropic (Automation vs Augmentation) — Anexo 1</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic_automation_index'</span>, <span class="st">'is_automation'</span>, <span class="st">'is_augmentation'</span>,</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>cols_existentes <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cols_finais <span class="cf">if</span> c <span class="kw">in</span> painel.columns]</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>cols_faltantes <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cols_finais <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> painel.columns]</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> cols_faltantes:</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"AVISO: Colunas não encontradas: </span><span class="sc">{</span>cols_faltantes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>painel_final <span class="op">=</span> painel[cols_existentes].copy()</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Remover ocupações sem score principal (2d) ──</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>n_antes <span class="op">=</span> <span class="bu">len</span>(painel_final)</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>painel_final <span class="op">=</span> painel_final[painel_final[<span class="st">'exposure_score_2d'</span>].notna()]</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>n_depois <span class="op">=</span> <span class="bu">len</span>(painel_final)</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_antes <span class="op">&gt;</span> n_depois:</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Removidas </span><span class="sc">{</span>n_antes <span class="op">-</span> n_depois<span class="sc">:,}</span><span class="ss"> linhas sem exposure_score_2d"</span>)</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Verificação para o Notebook 2b ──</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>cols_obrigatorias <span class="op">=</span> [<span class="st">'exposure_score_2d'</span>, <span class="st">'exposure_score_4d'</span>, <span class="st">'alta_exp'</span>, <span class="st">'did'</span>, <span class="st">'tempo_relativo_meses'</span>, <span class="st">'post'</span>]</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_obrigatorias:</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> painel_final.columns:</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Coluna obrigatória ausente para o DiD (Notebook 2b): </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> painel_final[cols_obrigatorias].isna().<span class="bu">any</span>().<span class="bu">any</span>():</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"NA em coluna obrigatória para o DiD (Notebook 2b)."</span>)</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Verificação: colunas obrigatórias para o 2b presentes e sem NA."</span>)</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Salvar ──</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>painel_final.to_parquet(PAINEL_FINAL_PARQUET, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>painel_final.to_csv(PAINEL_FINAL_CSV, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a><span class="co"># RESUMO FINAL</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a><span class="co"># ══════════════════════════════════════════════════════════════════════</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATASET ANALÍTICO FINAL — ETAPA 2a"</span>)</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Observações:        </span><span class="sc">{</span><span class="bu">len</span>(painel_final)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Ocupações (CBO 4d): </span><span class="sc">{</span>painel_final[<span class="st">'cbo_4d'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Períodos:           </span><span class="sc">{</span>painel_final[<span class="st">'periodo'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> meses"</span>)</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Pré-tratamento:   </span><span class="sc">{</span>painel_final[painel_final[<span class="st">'post'</span>]<span class="op">==</span><span class="dv">0</span>][<span class="st">'periodo'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Pós-tratamento:   </span><span class="sc">{</span>painel_final[painel_final[<span class="st">'post'</span>]<span class="op">==</span><span class="dv">1</span>][<span class="st">'periodo'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Cobertura 2d:       </span><span class="sc">{</span>painel_final[<span class="st">'exposure_score_2d'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Cobertura 4d:       </span><span class="sc">{</span>painel_final[<span class="st">'exposure_score_4d'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Tratamento 2d:      </span><span class="sc">{</span>painel_final[<span class="st">'alta_exp'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> das obs"</span>)</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Tratamento 4d:      </span><span class="sc">{</span>painel_final[<span class="st">'alta_exp_4d'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> das obs"</span>)</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Colunas:            </span><span class="sc">{</span>painel_final<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Salvo em:"</span>)</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>PAINEL_FINAL_PARQUET<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>PAINEL_FINAL_CSV<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>pq_mb <span class="op">=</span> PAINEL_FINAL_PARQUET.stat().st_size <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>csv_mb <span class="op">=</span> PAINEL_FINAL_CSV.stat().st_size <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Tamanho: </span><span class="sc">{</span>pq_mb<span class="sc">:.1f}</span><span class="ss"> MB (parquet), </span><span class="sc">{</span>csv_mb<span class="sc">:.1f}</span><span class="ss"> MB (csv)"</span>)</span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Info:"</span>)</span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>painel_final.info()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cache removido: painel_caged_did_ready.parquet
Cache removido: painel_caged_did_ready.csv
  Verificação: colunas obrigatórias para o 2b presentes e sem NA.

============================================================
DATASET ANALÍTICO FINAL — ETAPA 2a
============================================================
  Observações:        32,988
  Ocupações (CBO 4d): 629
  Períodos:           54 meses
    Pré-tratamento:   23
    Pós-tratamento:   31
  Cobertura 2d:       100.0%
  Cobertura 4d:       100.0%
  Tratamento 2d:      20.3% das obs
  Tratamento 4d:      21.3% das obs
  Colunas:            59

  Salvo em:
    data/output/painel_caged_did_ready.parquet
    data/output/painel_caged_did_ready.csv
    Tamanho: 7.2 MB (parquet), 21.0 MB (csv)

  Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 32988 entries, 0 to 32987
Data columns (total 59 columns):
 #   Column                      Non-Null Count  Dtype   
---  ------                      --------------  -----   
 0   cbo_4d                      32988 non-null  object  
 1   cbo_2d                      32988 non-null  object  
 2   ano                         32988 non-null  Int64   
 3   mes                         32988 non-null  Int64   
 4   periodo                     32988 non-null  object  
 5   periodo_num                 32988 non-null  int64   
 6   admissoes                   32988 non-null  Int64   
 7   desligamentos               32988 non-null  Int64   
 8   saldo                       32988 non-null  Int64   
 9   n_movimentacoes             32988 non-null  Int64   
 10  ln_admissoes                32988 non-null  Float64 
 11  ln_desligamentos            32988 non-null  Float64 
 12  salario_medio_adm           32988 non-null  float64 
 13  salario_mediano_adm         32988 non-null  float64 
 14  salario_medio_desl          32988 non-null  float64 
 15  ln_salario_adm              32988 non-null  float64 
 16  salario_sm                  32988 non-null  float64 
 17  ln_salario_sm               32988 non-null  float64 
 18  salario_real_adm            32988 non-null  float64 
 19  ln_salario_real_adm         32988 non-null  float64 
 20  idade_media_adm             32988 non-null  Float64 
 21  pct_mulher_adm              32988 non-null  float64 
 22  pct_superior_adm            32988 non-null  float64 
 23  pct_branco_adm              32988 non-null  float64 
 24  pct_negro_adm               32988 non-null  float64 
 25  pct_jovem_adm               32988 non-null  float64 
 26  pct_tecnologico_adm         32988 non-null  float64 
 27  setor_tecnologico           32988 non-null  int64   
 28  ln_salario_homem            32988 non-null  float64 
 29  ln_salario_mulher           32988 non-null  float64 
 30  ln_salario_jovem            32988 non-null  float64 
 31  ln_salario_naojovem         32988 non-null  float64 
 32  ln_salario_branco           32988 non-null  float64 
 33  ln_salario_negro            32988 non-null  float64 
 34  ln_salario_superior         32988 non-null  float64 
 35  ln_salario_medio            32988 non-null  float64 
 36  ln_admissoes_homem          32988 non-null  float64 
 37  ln_admissoes_mulher         32988 non-null  float64 
 38  ln_admissoes_jovem          32988 non-null  float64 
 39  ln_admissoes_negro          32988 non-null  float64 
 40  exposure_score_2d           32988 non-null  float64 
 41  exposure_score_4d           32988 non-null  float64 
 42  alta_exp                    32988 non-null  int64   
 43  alta_exp_10                 32988 non-null  int64   
 44  alta_exp_25                 32988 non-null  int64   
 45  alta_exp_mediana            32988 non-null  int64   
 46  quintil_exp                 32988 non-null  category
 47  alta_exp_4d                 32988 non-null  int64   
 48  post                        32988 non-null  int64   
 49  did                         32988 non-null  int64   
 50  did_4d                      32988 non-null  int64   
 51  tempo_relativo_meses        32988 non-null  int64   
 52  trend                       32988 non-null  int64   
 53  mes_do_ano                  32988 non-null  int64   
 54  grande_grupo_cbo            32988 non-null  object  
 55  grande_grupo_nome           32988 non-null  object  
 56  anthropic_automation_index  32988 non-null  float64 
 57  is_automation               32988 non-null  int64   
 58  is_augmentation             32988 non-null  int64   
dtypes: Float64(3), Int64(6), category(1), float64(29), int64(15), object(5)
memory usage: 14.9+ MB</code></pre>
</div>
</div>
</section>
<section id="limitações-desta-etapa" class="level3" data-number="0.18">
<h3 data-number="0.18" class="anchored" data-anchor-id="limitações-desta-etapa"><span class="header-section-number">0.18</span> Limitações desta etapa</h3>
<ol type="1">
<li><p><strong>Novo CAGED (descontinuidade 2020):</strong> A transição para o eSocial (2020) pode afetar a comparabilidade. Mitigamos ao iniciar em 2021 (eSocial já estabilizado, sem efeitos COVID).</p></li>
<li><p><strong>Fluxos vs.&nbsp;estoques:</strong> O CAGED mede movimentações (admissões/desligamentos), não o estoque de empregados. Quedas em admissões não significam necessariamente queda no emprego total — podem refletir menor rotatividade. Esta é a mesma lógica usada por Hui et al.&nbsp;(2024) com dados do Upwork.</p></li>
<li><p><strong>Crosswalk CBO → ISCO-08 (especificação principal, 2 dígitos):</strong> Ao agregar por Sub-major Group com fallback a Major Group, perdemos variação intragrupo. Ocupações diferentes dentro do mesmo grupo recebem o mesmo score. A especificação de robustez a 4 dígitos (com fallback hierárquico em 6 níveis) ajuda a avaliar se essa agregação afeta os resultados.</p></li>
<li><p><strong>Crosswalk CBO → ISCO-08 (robustez, 4 dígitos):</strong> O match direto CBO 4d = ISCO-08 4d cobre apenas ~28% das ocupações. Para o restante, usamos fallback hierárquico (via correspondência ISCO-88→ISCO-08, médias a 3d, 2d e 1d). Quanto mais granular o match, mais preciso o score — mas mesmo com fallback, a correlação entre as especificações 2d e 4d é &gt;0.91, indicando consistência. Erro de medição no tratamento tipicamente atenua os coeficientes (viés em direção a zero).</p></li>
<li><p><strong>Muendler: CBO 1994, não CBO 2002:</strong> O arquivo de concordância Muendler &amp; Poole (2004) mapeia a CBO <em>1994</em> (formato X-XX.XX), não a CBO 2002 (XXXX) usada no CAGED. A utilidade do Muendler para match 4d direto é limitada. A estratégia adotada usa a similaridade estrutural entre CBO 2002 e ISCO-08/88 (ambas baseadas na ISCO), combinada com a tabela oficial de correspondência ISCO-08↔︎ISCO-88.</p></li>
<li><p><strong>Emprego formal apenas:</strong> O CAGED cobre apenas o mercado formal (CLT). A informalidade (~40% da força de trabalho brasileira) não é capturada. Efeitos da IA sobre o setor informal requerem fontes alternativas (PNAD).</p></li>
<li><p><strong>Índice global aplicado ao Brasil:</strong> Mesma limitação da Etapa 1 — o índice ILO foi desenvolvido com foco global e pode não capturar especificidades do mercado de trabalho brasileiro.</p></li>
</ol>
<hr>
</section>
<section id="checklist-de-entregáveis" class="level3" data-number="0.19">
<h3 data-number="0.19" class="anchored" data-anchor-id="checklist-de-entregáveis"><span class="header-section-number">0.19</span> Checklist de entregáveis</h3>
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>data/raw/caged_{ano}.parquet</code> — Microdados CAGED por ano (2021–2025)</label></li>
<li><label><input type="checkbox" checked=""><code>data/input/cbo-isco-conc.csv</code> — Concordância Muendler CBO 1994→ISCO-88</label></li>
<li><label><input type="checkbox" checked=""><code>data/input/Correspondência ISCO 08 a 88.xlsx</code> — Tabela oficial ISCO-08↔︎ISCO-88</label></li>
<li><label><input type="checkbox" checked=""><code>data/processed/ilo_exposure_clean.csv</code> — Índice ILO processado (reusado da Etapa 1)</label></li>
<li><label><input type="checkbox" checked=""><code>data/output/painel_caged_did_ready.parquet</code> — Dataset analítico final (com scores 2d e 4d)</label></li>
<li><label><input type="checkbox" checked=""><code>data/output/painel_caged_did_ready.csv</code> — Backup CSV</label></li>
<li><label><input type="checkbox" checked="">Todos os CHECKPOINTs passando sem warnings críticos</label></li>
<li><label><input type="checkbox" checked="">Cobertura crosswalk 2d = 100%</label></li>
<li><label><input type="checkbox" checked="">Cobertura crosswalk 4d = 100% (com fallback hierárquico)</label></li>
<li><label><input type="checkbox" checked="">Correlação entre scores 2d e 4d: 0.9147</label></li>
<li><label><input type="checkbox" checked="">Sanity check por grande grupo coerente com a literatura</label></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>